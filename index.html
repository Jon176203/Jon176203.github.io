<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tụi mình</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="floating-hearts" aria-hidden="true">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
    <main class="love-card">
      <div class="hero-banner" id="heroBanner" hidden>
        <img id="heroImage" src="" alt="Khoảnh khắc của chúng ta" loading="lazy" />
      </div>
      <div class="title" id="storyTitle">Hành trình của tụi mình</div>
      <p class="story-subtitle" id="storySubtitle" hidden></p>
      <section class="couple">
        <div class="person">
          <div class="avatar">
            <img id="avatarA" src="assets/nguyenminhquan.jpg" alt="Nguyễn Minh Quân" />
          </div>
          <div class="name-tag" id="nameA">Tên người A</div>
        </div>
        <div class="heart">❤</div>
        <div class="person">
          <div class="avatar">
            <img id="avatarB" src="assets/diemquynh.jpg" alt="Châu Nguyễn Diễm Quỳnh" />
          </div>
          <div class="name-tag" id="nameB">Tên người B</div>
        </div>
      </section>
      <section class="time-tracker">
        <div class="time-cards">
          <div class="time-card">
            <span class="time-value" id="yearsValue">0</span>
            <span class="time-label">Năm</span>
          </div>
          <div class="time-card">
            <span class="time-value" id="monthsValue">0</span>
            <span class="time-label">Tháng</span>
          </div>
          <div class="time-card">
            <span class="time-value" id="weeksValue">0</span>
            <span class="time-label">Tuần</span>
          </div>
          <div class="time-card">
            <span class="time-value" id="daysValue">0</span>
            <span class="time-label">Ngày</span>
          </div>
        </div>
        <div class="time-meta">
          <span class="since-pill" id="sinceDate">25/10/2025</span>
          <span class="clock" id="liveClock">00 : 00 : 00</span>
        </div>
        <div class="days-counter" id="dayCount">0 ngày bên nhau</div>
      </section>
      <button class="timeline-toggle" id="timelineToggle" type="button">
        Xem cột mốc yêu thương
      </button>
      <section class="timeline" id="timelineSection" aria-hidden="true">
        <div class="timeline-grid" id="timelineGrid"></div>
      </section>
      <footer>
        <span></span>
      </footer>
    </main>

    <div class="lightbox" id="lightbox" hidden>
      <div class="lightbox__backdrop" data-lightbox-close></div>
      <div class="lightbox__dialog" role="dialog" aria-modal="true" aria-label="Xem hình ảnh chi tiết">
        <button class="lightbox__close" type="button" data-lightbox-close aria-label="Đóng">×</button>
        <div class="lightbox__media" id="lightboxMedia"></div>
        <p class="lightbox__caption" id="lightboxCaption"></p>
      </div>
    </div>

    <script>
      const DATA_URL = "data/story.json";
      const MILLIS_PER_DAY = 1000 * 60 * 60 * 24;

      let storyConfig = null;
      let startDate;

      const LIGHTBOX_TRIGGER_SELECTOR = "[data-media-trigger]";
      let lightboxElement;
      let lightboxMediaContainer;
      let lightboxCaptionElement;
      let lastFocusedMediaTrigger = null;

      function escapeHtml(value = "") {
        return value
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function escapeAttribute(value = "") {
        return escapeHtml(value);
      }

      async function loadStoryConfig() {
        const response = await fetch(DATA_URL, { cache: "no-store" });

        if (!response.ok) {
          throw new Error(`Không thể tải dữ liệu (${response.status})`);
        }

        return response.json();
      }

      function formatDate(dateString) {
        const [year, month, day] = dateString.split("-");
        return `${day}/${month}/${year}`;
      }

      function padTwo(value) {
        return value.toString().padStart(2, "0");
      }

      function applyConfig(config) {
        storyConfig = config;

        const {
          title,
          subtitle,
          startDate: startDateString,
          hero,
          people: { personA, personB } = {},
          timeline = [],
        } = config;

        const titleElement = document.getElementById("storyTitle");
        if (titleElement && title) {
          titleElement.textContent = title;
        }

        const subtitleElement = document.getElementById("storySubtitle");
        if (subtitleElement) {
          if (subtitle) {
            subtitleElement.textContent = subtitle;
            subtitleElement.hidden = false;
          } else {
            subtitleElement.hidden = true;
          }
        }

        const heroBanner = document.getElementById("heroBanner");
        const heroImage = document.getElementById("heroImage");
        if (heroBanner && heroImage) {
          if (hero?.image) {
            heroImage.src = hero.image;
            heroImage.alt = hero.alt || "Khoảnh khắc của chúng ta";
            heroBanner.hidden = false;
          } else {
            heroBanner.hidden = true;
          }
        }

        const nameAElement = document.getElementById("nameA");
        const avatarAElement = document.getElementById("avatarA");
        if (personA && nameAElement && avatarAElement) {
          nameAElement.textContent = personA.name || "Người ấy";
          if (personA.avatar) {
            avatarAElement.src = personA.avatar;
          }
          avatarAElement.alt = personA.name || "Người ấy";
        }

        const nameBElement = document.getElementById("nameB");
        const avatarBElement = document.getElementById("avatarB");
        if (personB && nameBElement && avatarBElement) {
          nameBElement.textContent = personB.name || "Người ấy";
          if (personB.avatar) {
            avatarBElement.src = personB.avatar;
          }
          avatarBElement.alt = personB.name || "Người ấy";
        }

        if (startDateString) {
          document.getElementById("sinceDate").textContent = formatDate(startDateString);
          startDate = new Date(`${startDateString}T00:00:00`);
          startDate.setHours(0, 0, 0, 0);
        }

        renderTimeline(timeline);
      }

      function isVideoMedia(media) {
        if (!media || !media.src) return false;
        const declaredType = media.type?.toLowerCase();
        if (declaredType === "video") return true;
        const videoExtensions = ["mp4", "webm", "ogg", "mov", "m4v"];
        const extension = media.src.split("?")[0].split(".").pop()?.toLowerCase();
        return extension ? videoExtensions.includes(extension) : false;
      }

      function renderMediaFigure(media, options = {}) {
        const { fallbackTitle = "", isPrimary = false } = options;
        if (!media || !media.src) return "";

        const isVideo = isVideoMedia(media);
        const captionText = media.caption || media.alt || fallbackTitle;
        const safeCaption = captionText ? escapeHtml(captionText) : "";
        const figureClass = isPrimary ? "timeline-card__media" : "timeline-card__gallery-item";

        const datasetAttributes = [
          'data-media-trigger="true"',
          `data-media-type="${isVideo ? "video" : "image"}"`,
          `data-media-src="${escapeAttribute(media.src)}"`,
        ];

        if (media.poster) {
          datasetAttributes.push(`data-media-poster="${escapeAttribute(media.poster)}"`);
        }

        if (media.mimeType) {
          datasetAttributes.push(`data-media-mime="${escapeAttribute(media.mimeType)}"`);
        }

        if (captionText) {
          datasetAttributes.push(`data-media-caption="${escapeAttribute(captionText)}"`);
        }

        const mediaContent = isVideo
          ? `<video playsinline preload="metadata" muted>
                <source src="${media.src}" ${media.mimeType ? `type="${media.mimeType}"` : ""} />
                Trình duyệt của bạn không hỗ trợ video.
              </video>`
          : `<img src="${media.src}" alt="${escapeAttribute(media.alt || fallbackTitle)}" loading="lazy" />`;

        return `
          <figure class="${figureClass}" tabindex="0" ${datasetAttributes.join(" ")}>
            ${mediaContent}
            ${safeCaption ? `<figcaption class="timeline-card__caption${
              isPrimary ? "" : " timeline-card__caption--secondary"
            }">${safeCaption}</figcaption>` : ""}
          </figure>
        `;
      }

      function createTimelineGallery(mediaItems, fallbackTitle) {
        if (!Array.isArray(mediaItems) || mediaItems.length === 0) {
          return { main: "", gallery: "" };
        }

        const [primary, ...rest] = mediaItems;

        const main = renderMediaFigure(primary, { fallbackTitle, isPrimary: true });

        const gallery = rest.length
          ? `<div class="timeline-card__gallery">${rest
              .map((item) => renderMediaFigure(item, { fallbackTitle }))
              .join("")}</div>`
          : "";

        return { main, gallery };
      }

      function createTimelineCard(entry) {
        const { date, title, description, location, images } = entry;
        const formattedDate = formatDate(date);
        const { main, gallery } = createTimelineGallery(images, title);
        const hasMainImage = Boolean(main);
        const cardClass = `timeline-card${hasMainImage ? "" : " timeline-card--compact"}`;

        return `
          <article class="${cardClass}">
            ${main}
            <div class="timeline-card__body">
              <span class="timeline-card__date">${formattedDate}</span>
              <h3 class="timeline-card__title">${title}</h3>
              ${location ? `<span class="timeline-card__location">${location}</span>` : ""}
              ${
                description
                  ? `<p class="timeline-card__description">${description}</p>`
                  : ""
              }
              ${gallery}
            </div>
          </article>
        `;
      }

      function renderTimeline(entries) {
        const grid = document.getElementById("timelineGrid");

        if (!grid) return;

        if (!Array.isArray(entries) || entries.length === 0) {
          grid.innerHTML =
            '<p class="timeline-empty">Chưa có cột mốc nào — cùng nhau tạo nên nhé!</p>';
          return;
        }

        const orderedEntries = entries.slice();
        grid.innerHTML = orderedEntries.map(createTimelineCard).join("");
        attachLightboxHandlers();
      }

      function openLightbox({ type, src, poster, caption, mime }) {
        if (!lightboxElement || !lightboxMediaContainer) return;

        lightboxMediaContainer.innerHTML = "";

        let mediaElement;
        if (type === "video") {
          mediaElement = document.createElement("video");
          mediaElement.controls = true;
          mediaElement.autoplay = true;
          mediaElement.playsInline = true;
          mediaElement.preload = "metadata";
          if (poster) {
            mediaElement.poster = poster;
          }

          const source = document.createElement("source");
          source.src = src;
          if (mime) {
            source.type = mime;
          }
          mediaElement.appendChild(source);
        } else {
          mediaElement = document.createElement("img");
          mediaElement.src = src;
          mediaElement.alt = caption || "";
        }

        lightboxMediaContainer.appendChild(mediaElement);

        if (lightboxCaptionElement) {
          if (caption) {
            lightboxCaptionElement.textContent = caption;
            lightboxCaptionElement.classList.remove("lightbox__caption--hidden");
          } else {
            lightboxCaptionElement.textContent = "";
            lightboxCaptionElement.classList.add("lightbox__caption--hidden");
          }
        }

        lightboxElement.removeAttribute("hidden");
        lightboxElement.classList.add("lightbox--open");
        document.body.classList.add("lightbox-open");

        const closeButton = lightboxElement.querySelector(".lightbox__close");
        closeButton?.focus();
      }

      function closeLightbox() {
        if (!lightboxElement || !lightboxElement.classList.contains("lightbox--open")) {
          return;
        }

        const activeVideo = lightboxMediaContainer?.querySelector("video");
        if (activeVideo) {
          activeVideo.pause();
          activeVideo.removeAttribute("src");
          activeVideo.load();
        }

        if (lightboxMediaContainer) {
          lightboxMediaContainer.innerHTML = "";
        }

        lightboxElement.classList.remove("lightbox--open");
        lightboxElement.setAttribute("hidden", "");
        document.body.classList.remove("lightbox-open");

        if (lastFocusedMediaTrigger) {
          lastFocusedMediaTrigger.focus();
        }
      }

      function handleMediaTriggerActivation(trigger) {
        if (!trigger) return;
        lastFocusedMediaTrigger = trigger;

        openLightbox({
          type: trigger.dataset.mediaType,
          src: trigger.dataset.mediaSrc,
          poster: trigger.dataset.mediaPoster,
          caption: trigger.dataset.mediaCaption,
          mime: trigger.dataset.mediaMime,
        });
      }

      function handleMediaTriggerClick(event) {
        event.preventDefault();
        handleMediaTriggerActivation(event.currentTarget);
      }

      function handleMediaTriggerKeydown(event) {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          handleMediaTriggerActivation(event.currentTarget);
        }
      }

      function attachLightboxHandlers() {
        const triggers = document.querySelectorAll(LIGHTBOX_TRIGGER_SELECTOR);
        triggers.forEach((trigger) => {
          if (trigger.dataset.lightboxBound === "true") {
            return;
          }

          trigger.dataset.lightboxBound = "true";
          trigger.addEventListener("click", handleMediaTriggerClick);
          trigger.addEventListener("keydown", handleMediaTriggerKeydown);
        });
      }

      function setupLightboxInfrastructure() {
        lightboxElement = document.getElementById("lightbox");
        lightboxMediaContainer = document.getElementById("lightboxMedia");
        lightboxCaptionElement = document.getElementById("lightboxCaption");

        if (!lightboxElement) {
          return;
        }

        lightboxElement.addEventListener("click", (event) => {
          if (event.target && "lightboxClose" in event.target.dataset) {
            closeLightbox();
          }
        });

        const closeButtons = lightboxElement.querySelectorAll("[data-lightbox-close]");
        closeButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            event.preventDefault();
            closeLightbox();
          });
        });
      }

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeLightbox();
        }
      });

      function calculateDurations(now = new Date()) {
        if (!startDate) {
          return { years: 0, months: 0, weeks: 0, days: 0, totalDaysSinceStart: 0 };
        }

        const reference = new Date(now.getTime());
        reference.setHours(0, 0, 0, 0);

        let cursor = new Date(startDate.getTime());
        let years = 0;

        while (true) {
          const next = new Date(cursor);
          next.setFullYear(next.getFullYear() + 1);
          if (next <= reference) {
            years += 1;
            cursor = next;
          } else {
            break;
          }
        }

        let months = 0;
        while (true) {
          const next = new Date(cursor);
          next.setMonth(next.getMonth() + 1);
          if (next <= reference) {
            months += 1;
            cursor = next;
          } else {
            break;
          }
        }

        const remainingMs = reference - cursor;
        const totalDaysRemainder = Math.floor(remainingMs / MILLIS_PER_DAY);
        const weeks = Math.floor(totalDaysRemainder / 7);
        const days = totalDaysRemainder % 7;

        const totalDaysSinceStart =
          Math.floor(
            (Date.UTC(
              reference.getFullYear(),
              reference.getMonth(),
              reference.getDate()
            ) -
              Date.UTC(
                startDate.getFullYear(),
                startDate.getMonth(),
                startDate.getDate()
              )) /
              MILLIS_PER_DAY
          ) + 1;

        return { years, months, weeks, days, totalDaysSinceStart };
      }

      function updateDurations() {
        const { years, months, weeks, days, totalDaysSinceStart } = calculateDurations();

        document.getElementById("yearsValue").textContent = padTwo(years);
        document.getElementById("monthsValue").textContent = padTwo(months);
        document.getElementById("weeksValue").textContent = padTwo(weeks);
        document.getElementById("daysValue").textContent = padTwo(days);
        document.getElementById("dayCount").textContent = `${totalDaysSinceStart} ngày bên nhau`;
      }

      function updateClock() {
        const now = new Date();
        const hours = padTwo(now.getHours());
        const minutes = padTwo(now.getMinutes());
        const seconds = padTwo(now.getSeconds());
        document.getElementById("liveClock").textContent = `${hours} : ${minutes} : ${seconds}`;
      }

      function displayError(message) {
        const grid = document.getElementById("timelineGrid");
        if (grid) {
          grid.innerHTML = `<p class="timeline-empty">${message}</p>`;
        }
      }

      async function initStory() {
        try {
          const data = await loadStoryConfig();
          applyConfig(data);
          updateDurations();
          updateClock();

          setInterval(() => {
            updateDurations();
            updateClock();
          }, 1000);
        } catch (error) {
          console.error(error);
          displayError("Không thể tải dữ liệu câu chuyện. Vui lòng thử lại sau.");
        }
      }

      const timelineToggle = document.getElementById("timelineToggle");
      const timelineSection = document.getElementById("timelineSection");

      if (timelineToggle && timelineSection) {
        timelineToggle.addEventListener("click", () => {
          const isOpen = timelineSection.classList.toggle("open");
          timelineSection.setAttribute("aria-hidden", (!isOpen).toString());
          timelineToggle.textContent = isOpen
            ? "Ẩn cột mốc yêu thương"
            : "Xem cột mốc yêu thương";
        });
      }

      setupLightboxInfrastructure();
      initStory();
    </script>
  </body>
</html>

