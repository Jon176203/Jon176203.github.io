<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T·ª•i m√¨nh</title>
    <meta
      name="description"
      content="H√†nh tr√¨nh c·ªßa Qu√¢n v√† Qu·ª≥nh ‚Äì ghi l·∫°i t·ª´ng kho·∫£nh kh·∫Øc y√™u th∆∞∆°ng c·ªßa t·ª•i m√¨nh."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://jon176203.github.io/" />
    <meta property="og:title" content="H√†nh tr√¨nh c·ªßa Qu√¢n v√† Qu·ª≥nh" />
    <meta
      property="og:description"
      content="Ghi l·∫°i t·ª´ng k·ª∑ ni·ªám ƒë√°ng nh·ªõ c·ªßa t·ª•i m√¨nh."
    />
    <meta
      property="og:image"
      content="https://www.pinterest.com/pin/28147566416398576/"
    />
    <meta
      property="og:image:alt"
      content="Kho·∫£nh kh·∫Øc c·ªßa Qu√¢n v√† Qu·ª≥nh"
    />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="H√†nh tr√¨nh c·ªßa Qu√¢n v√† Qu·ª≥nh" />
    <meta
      name="twitter:description"
      content="Ghi l·∫°i t·ª´ng k·ª∑ ni·ªám ƒë√°ng nh·ªõ c·ªßa t·ª•i m√¨nh."
    />
    <meta
      name="twitter:image"
      content="https://jon176203.github.io/assets/quanchodoi.jpg"
    />
    <link rel="icon" type="image/svg+xml" href="assets/heart-favicon.svg" />
    <link rel="alternate icon" href="assets/heart-favicon.svg" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="floating-hearts" aria-hidden="true">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
    <main class="love-card">
      <div class="hero-banner" id="heroBanner" hidden>
        <img id="heroImage" src="" alt="Kho·∫£nh kh·∫Øc c·ªßa ch√∫ng ta" loading="lazy" />
      </div>
      <div class="title" id="storyTitle">H√†nh tr√¨nh c·ªßa t·ª•i m√¨nh</div>
      <p class="story-subtitle" id="storySubtitle" hidden></p>
      <section class="couple">
        <div class="person">
          <div class="avatar">
            <img id="avatarA" src="assets/nguyenminhquan.jpg" alt="Nguy·ªÖn Minh Qu√¢n" />
          </div>
          <div class="name-tag" id="nameA">T√™n ng∆∞·ªùi A</div>
          <div class="zodiac-tag" id="zodiacA" hidden>Cung ho√†ng ƒë·∫°o</div>
        </div>
        <div
          class="heart"
          id="unlockHeart"
          role="button"
          tabindex="0"
          aria-label="M·ªü kh√≥a form th√™m c·ªôt m·ªëc b·∫±ng m·∫≠t kh·∫©u"
        >
          ‚ù§
        </div>
        <div class="person">
          <div class="avatar">
            <img id="avatarB" src="assets/diemquynh.jpg" alt="Ch√¢u Nguy·ªÖn Di·ªÖm Qu·ª≥nh" />
          </div>
          <div class="name-tag" id="nameB">T√™n ng∆∞·ªùi B</div>
          <div class="zodiac-tag" id="zodiacB" hidden>Cung ho√†ng ƒë·∫°o</div>
        </div>
      </section>
      <section class="time-tracker">
        <div class="time-slider" id="timeSlider" aria-live="polite">
          <div class="time-slide time-slide--metrics" data-active="true">
            <div class="time-cards">
              <div class="time-card">
                <span class="time-value" id="yearsValue">0</span>
                <span class="time-label">NƒÉm</span>
              </div>
              <div class="time-card">
                <span class="time-value" id="monthsValue">0</span>
                <span class="time-label">Th√°ng</span>
              </div>
              <div class="time-card">
                <span class="time-value" id="weeksValue">0</span>
                <span class="time-label">Tu·∫ßn</span>
              </div>
              <div class="time-card">
                <span class="time-value" id="daysValue">0</span>
                <span class="time-label">Ng√†y</span>
              </div>
            </div>
            <div class="time-meta">
              <span class="since-pill" id="sinceDate">25/10/2025</span>
              <span class="clock" id="liveClock">00 : 00 : 00</span>
            </div>
          </div>
          <div class="time-slide time-slide--days" data-active="false">
            <div class="days-panel">
              <div class="days-counter" id="dayCount">0 ng√†y b√™n nhau</div>
              <p class="days-subtext">C√πng nhau vi·∫øt ti·∫øp c√¢u chuy·ªán y√™u th∆∞∆°ng nha :33</p>
            </div>
          </div>
        </div>
        <div class="time-indicators" id="timeDots" role="tablist" aria-label="Chuy·ªÉn ƒë·ªïi hi·ªÉn th·ªã th·ªùi gian">
          <button
            type="button"
            class="time-indicator is-active"
            data-time-dot="0"
            aria-label="Xem chi ti·∫øt theo nƒÉm th√°ng"
            aria-pressed="true"
          ></button>
          <button
            type="button"
            class="time-indicator"
            data-time-dot="1"
            aria-label="Xem t·ªïng s·ªë ng√†y b√™n nhau"
            aria-pressed="false"
          ></button>
        </div>
      </section>
      <button class="timeline-toggle" id="timelineToggle" type="button">
        Xem c·ªôt m·ªëc y√™u th∆∞∆°ng
      </button>
      <section class="timeline" id="timelineSection" aria-hidden="true">
        <div class="timeline-grid" id="timelineGrid"></div>
      </section>
      <section class="timeline-submit" id="timelineSubmitSection" hidden>
        <h2 class="timeline-submit__title">Th√™m c·ªôt m·ªëc y√™u th∆∞∆°ng</h2>
        <p class="timeline-submit__hint">
          Chia s·∫ª kho·∫£nh kh·∫Øc ƒë·∫∑c bi·ªát c·ªßa b·∫°n ƒë·ªÉ m·ªçi ng∆∞·ªùi c√πng ng·∫Øm nh√©!
        </p>
        <form class="timeline-form" id="timelineForm" novalidate hidden>
          <div class="timeline-form__grid">
            <label class="timeline-form__field">
              <span>Ng√†y di·ªÖn ra *</span>
              <div class="timeline-form__date-wrapper">
                <input
                  type="text"
                  id="timelineDateDisplay"
                  class="timeline-form__date-display"
                  placeholder="dd/mm/yyyy"
                  readonly
                />
                <input
                  type="date"
                  name="date"
                  id="timelineDateInput"
                  class="timeline-form__date-input-hidden"
                  required
                />
                <button
                  type="button"
                  class="timeline-form__date-icon"
                  id="timelineDateIconBtn"
                  aria-label="M·ªü l·ªãch"
                  title="Ch·ªçn ng√†y"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                </button>
              </div>
            </label>
            <label class="timeline-form__field">
              <span>Ti√™u ƒë·ªÅ *</span>
              <input type="text" name="title" maxlength="120" required placeholder="V√≠ d·ª•: Bu·ªïi h·∫πn ƒë·∫ßu" />
            </label>
            <label class="timeline-form__field timeline-form__field--full">
              <span>ƒê·ªãa ƒëi·ªÉm</span>
              <input type="text" name="location" maxlength="120" placeholder="V√≠ d·ª•: C√¥ng vi√™n s√°ng t·∫°o" />
            </label>
            <label class="timeline-form__field timeline-form__field--full">
              <span>K·ªÉ l·∫°i k·ª∑ ni·ªám</span>
              <textarea
                name="description"
                rows="3"
                maxlength="800"
                placeholder="B·∫°n mu·ªën l∆∞u l·∫°i ƒëi·ªÅu g√¨ ·ªü kho·∫£nh kh·∫Øc n√†y?"
              ></textarea>
            </label>
            <label class="timeline-form__field timeline-form__field--full">
              <span>Ch·ªçn h√¨nh ho·∫∑c video t·ª´ thi·∫øt b·ªã</span>
              <div class="timeline-form__file-input-wrapper">
                <input
                  type="file"
                  name="mediaFile"
                  id="timelineMediaFile"
                  accept="image/*,video/*"
                  multiple
                />
                <button
                  type="button"
                  class="timeline-form__add-more-btn"
                  id="timelineAddMoreMediaBtn"
                  hidden
                >
                  + Th√™m ·∫£nh/video
                </button>
              </div>
              <small class="timeline-form__hint">
                B·∫°n c√≥ th·ªÉ ch·ªçn nhi·ªÅu file c√πng l√∫c. ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† ·∫£nh ƒë·∫°i di·ªán, c√°c ·∫£nh sau s·∫Ω hi·ªÉn th·ªã k√®m theo.
              </small>
            </label>
            <div class="timeline-media-preview" id="timelineMediaPreviewContainer" hidden>
              <p class="timeline-media-preview__hint">
                K√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp th·ª© t·ª± ·∫£nh. ·∫¢nh ƒë·∫ßu ti√™n (c√≥ nh√£n "·∫¢nh ƒë·∫°i di·ªán") s·∫Ω l√† ·∫£nh ch√≠nh. ƒêi·ªÅn ch√∫ th√≠ch cho t·ª´ng ·∫£nh nh√© üíå
              </p>
              <div class="timeline-media-preview__list" id="timelineMediaPreviewList"></div>
            </div>
          </div>
          <button class="timeline-form__submit" id="timelineSubmitButton" type="submit">G·ª≠i c·ªôt m·ªëc</button>
          <p class="timeline-form__status" id="timelineFormStatus" role="status" aria-live="polite"></p>
        </form>
      </section>
      <footer>
        <span></span>
      </footer>
    </main>

    <div class="heart-menu-modal" id="heartMenuModal" hidden>
      <div class="heart-menu-modal__backdrop" data-heart-menu-close></div>
      <div
        class="heart-menu-modal__dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="heartMenuTitle"
      >
        <button
          type="button"
          class="heart-menu-modal__close"
          data-heart-menu-close
          aria-label="ƒê√≥ng"
        >
          √ó
        </button>
        <h2 class="heart-menu-modal__title" id="heartMenuTitle">
          Ch·ªçn ch·ª©c nƒÉng üíù
        </h2>
        <p class="heart-menu-modal__hint">
          B·∫°n mu·ªën l√†m g√¨ ti·∫øp theo?
        </p>
        <div class="heart-menu-modal__buttons">
          <button
            type="button"
            class="heart-menu-modal__button"
            id="heartMenuTodoButton"
            data-action="todo"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 11 12 14 22 4"></polyline>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span>Xem danh s√°ch vi·ªác l√†m c√πng nhaoo</span>
          </button>
          <button
            type="button"
            class="heart-menu-modal__button"
            id="heartMenuTimelineButton"
            data-action="timeline"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span>Qu·∫£n l√Ω c·ªôt m·ªëc y√™u th∆∞∆°ng</span>
          </button>
        </div>
      </div>
    </div>

    <div class="timeline-password-modal" id="timelinePasswordModal" hidden>
      <div class="timeline-password-modal__backdrop" data-password-modal-close></div>
      <div
        class="timeline-password-modal__dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="timelinePasswordTitle"
      >
        <button
          type="button"
          class="timeline-password-modal__close"
          data-password-modal-close
          aria-label="ƒê√≥ng"
        >
          √ó
        </button>
        <h2 class="timeline-password-modal__title" id="timelinePasswordTitle">
          M·∫≠t kh·∫©u  üíù
        </h2>
        <p class="timeline-password-modal__hint">
          Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kh√≥a form th√™m c·ªôt m·ªëc nh√©!
        </p>
        <form class="timeline-password" id="timelinePasswordForm" autocomplete="off">
          <label class="timeline-form__field timeline-form__field--full">
            <span>M·∫≠t kh·∫©u *</span>
            <div class="timeline-form__password-wrapper">
              <input
                type="password"
                name="timelinePassword"
                id="timelinePasswordInput"
                required
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                minlength="4"
              />
              <button
                type="button"
                class="timeline-form__password-toggle"
                id="timelinePasswordToggle"
                aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u"
                title="Hi·ªán/·∫©n m·∫≠t kh·∫©u"
              >
                <svg
                  class="timeline-form__password-icon timeline-form__password-icon--hidden"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg
                  class="timeline-form__password-icon timeline-form__password-icon--visible"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  style="display: none;"
                >
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
          </label>
          <button
            class="timeline-form__submit timeline-password__submit"
            id="timelinePasswordUnlockButton"
            type="submit"
          >
            M·ªü kh√≥a
          </button>
          <p class="timeline-form__status" id="timelinePasswordStatus" role="status" aria-live="polite"></p>
        </form>
      </div>
    </div>

    <div class="lightbox" id="lightbox" hidden>
      <div class="lightbox__backdrop" data-lightbox-close></div>
      <div class="lightbox__dialog" role="dialog" aria-modal="true" aria-label="Xem h√¨nh ·∫£nh chi ti·∫øt">
        <button class="lightbox__close" type="button" data-lightbox-close aria-label="ƒê√≥ng">√ó</button>
        <div class="lightbox__media" id="lightboxMedia"></div>
        <p class="lightbox__caption" id="lightboxCaption"></p>
      </div>
    </div>

    <div class="timeline-add-image-modal" id="timelineAddImageModal" hidden>
      <div class="timeline-add-image-modal__backdrop" data-add-image-modal-close></div>
      <div
        class="timeline-add-image-modal__dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="timelineAddImageTitle"
      >
        <button
          type="button"
          class="timeline-add-image-modal__close"
          data-add-image-modal-close
          aria-label="ƒê√≥ng"
        >
          √ó
        </button>
        <h2 class="timeline-add-image-modal__title" id="timelineAddImageTitle">
          Th√™m ·∫£nh v√†o c·ªôt m·ªëc
        </h2>
        <p class="timeline-add-image-modal__hint">
          Ch·ªçn ·∫£nh ho·∫∑c video ƒë·ªÉ th√™m v√†o c·ªôt m·ªëc n√†y nh√©!
        </p>
        <form class="timeline-add-image-form" id="timelineAddImageForm" novalidate>
          <label class="timeline-form__field timeline-form__field--full">
            <span>Ch·ªçn h√¨nh ho·∫∑c video t·ª´ thi·∫øt b·ªã</span>
            <div class="timeline-form__file-input-wrapper">
              <input
                type="file"
                name="addImageFile"
                id="timelineAddImageFile"
                accept="image/*,video/*"
                multiple
              />
              <button
                type="button"
                class="timeline-form__add-more-btn"
                id="timelineAddImageMoreBtn"
                hidden
              >
                + Th√™m ·∫£nh/video
              </button>
            </div>
            <small class="timeline-form__hint">
              B·∫°n c√≥ th·ªÉ ch·ªçn nhi·ªÅu file c√πng l√∫c.
            </small>
          </label>
          <div class="timeline-media-preview" id="timelineAddImagePreviewContainer" hidden>
            <p class="timeline-media-preview__hint">
              ƒêi·ªÅn ch√∫ th√≠ch cho t·ª´ng ·∫£nh nh√© üíå
            </p>
            <div class="timeline-media-preview__list" id="timelineAddImagePreviewList"></div>
          </div>
          <button class="timeline-form__submit" id="timelineAddImageSubmitButton" type="submit">
            Th√™m ·∫£nh
          </button>
          <p class="timeline-form__status" id="timelineAddImageStatus" role="status" aria-live="polite"></p>
        </form>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
      const DATA_URL = "data/story.json";
      const MILLIS_PER_DAY = 1000 * 60 * 60 * 24;
      const ZODIAC_SYMBOLS = {
        "bach duong": "‚ôà",
        "kim nguu": "‚ôâ",
        "song tu": "‚ôä",
        "cu giai": "‚ôã",
        "su tu": "‚ôå",
        "xu nu": "‚ôç",
        "thien binh": "‚ôé",
        "bo cap": "‚ôè",
        "nhan ma": "‚ôê",
        "ma ket": "‚ôë",
        "bao binh": "‚ôí",
        "song ngu": "‚ôì",
        gemini: "‚ôä",
        scorpio: "‚ôè",
      };

      const TIMELINE_COLLECTION = "timelineEntries";
      const TIMELINE_FORM_PASSWORD = "tuilavoquan";
      const STORAGE_UPLOAD_FOLDER = "timelineUploads";
      const MAX_UPLOAD_SIZE_BYTES = 12 * 1024 * 1024; // ~12MB

      let storyConfig = null;
      let startDate;
      let firestore = null;
      let storage = null;
      let timelineUnsubscribe = null;
      let timelineFallback = [];
      let isFirebaseReady = false;
      let timelineFormUnlocked = false;
      let timelineMediaSelections = [];
      let timelineAddImageSelections = [];
      let currentTimelineEntryId = null;

      const LIGHTBOX_TRIGGER_SELECTOR = "[data-media-trigger]";
      let lightboxElement;
      let lightboxMediaContainer;
      let lightboxCaptionElement;
      let lastFocusedMediaTrigger = null;

      function escapeHtml(value = "") {
        return value
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function escapeAttribute(value = "") {
        return escapeHtml(value);
      }

      function normalizeZodiacKey(value = "") {
        return value
          .toString()
          .trim()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
      }

      function getZodiacSymbol(name = "") {
        const key = normalizeZodiacKey(name);
        return ZODIAC_SYMBOLS[key] || "";
      }

      function renderZodiacTag(element, zodiacName) {
        if (!element) return;

        if (!zodiacName) {
          element.hidden = true;
          element.innerHTML = "";
          return;
        }

        const symbol = getZodiacSymbol(zodiacName);
        const safeName = escapeHtml(zodiacName);
        const iconMarkup = symbol
          ? `<span class="zodiac-icon" aria-hidden="true">${symbol}</span>`
          : "";

        element.innerHTML = `${iconMarkup}<span class="zodiac-label">${safeName}</span>`;
        element.hidden = false;
      }

      function setupTimeSlider() {
        const slider = document.getElementById("timeSlider");
        const dotsContainer = document.getElementById("timeDots");
        if (!slider || !dotsContainer) {
          return;
        }

        const slides = Array.from(slider.querySelectorAll(".time-slide"));
        const dotButtons = Array.from(dotsContainer.querySelectorAll("[data-time-dot]"));

        if (!slides.length || dotButtons.length !== slides.length) {
          return;
        }

        let currentIndex = 0;
        const maxIndex = slides.length - 1;
        const swipeThreshold = 48;
        let pointerStartX = 0;
        let pointerActive = false;

        function updateDots() {
          dotButtons.forEach((dot, index) => {
            const isActive = index === currentIndex;
            dot.classList.toggle("is-active", isActive);
            dot.setAttribute("aria-pressed", isActive.toString());
          });
        }

        function clampIndex(index) {
          return Math.max(0, Math.min(index, maxIndex));
        }

        function updateSlides() {
          slides.forEach((slide, index) => {
            slide.dataset.active = index === currentIndex ? "true" : "false";
          });
          slider.dataset.activeIndex = String(currentIndex);
        }

        function goToSlide(index) {
          currentIndex = clampIndex(index);
          updateSlides();
          updateDots();
        }

        function handleDotInteraction(event) {
          const target = event.currentTarget;
          const index = Number.parseInt(target.dataset.timeDot, 10);
          if (Number.isNaN(index)) {
            return;
          }

          event.preventDefault();
          goToSlide(index);
        }

        dotButtons.forEach((dot) => {
          dot.addEventListener("click", handleDotInteraction);
          dot.addEventListener("keydown", (event) => {
            if (event.key === "Enter" || event.key === " ") {
              handleDotInteraction(event);
            }
          });
        });

        function finalizeSwipe(deltaX) {
          if (Math.abs(deltaX) > swipeThreshold) {
            goToSlide(currentIndex + (deltaX < 0 ? 1 : -1));
          } else {
            goToSlide(currentIndex);
          }
        }

        function handlePointerDown(event) {
          pointerActive = true;
          pointerStartX = event.clientX;
          if (event.pointerId !== undefined) {
            slider.setPointerCapture(event.pointerId);
          }
        }

        function handlePointerUp(event) {
          if (!pointerActive) {
            return;
          }

          const deltaX = event.clientX - pointerStartX;
          finalizeSwipe(deltaX);
          pointerActive = false;
          if (event.pointerId !== undefined && slider.hasPointerCapture(event.pointerId)) {
            slider.releasePointerCapture(event.pointerId);
          }
        }

        function handlePointerMove(event) {
          if (!pointerActive) {
            return;
          }

          event.preventDefault();
        }

        function handlePointerCancel(event) {
          pointerActive = false;
          if (event.pointerId !== undefined && slider.hasPointerCapture(event.pointerId)) {
            slider.releasePointerCapture(event.pointerId);
          }
        }

        if (window.PointerEvent) {
          slider.addEventListener("pointerdown", handlePointerDown);
          slider.addEventListener("pointermove", handlePointerMove);
          slider.addEventListener("pointerup", handlePointerUp);
          slider.addEventListener("pointerleave", handlePointerUp);
          slider.addEventListener("pointercancel", handlePointerCancel);
        } else {
          slider.addEventListener("touchstart", (event) => {
            pointerActive = true;
            pointerStartX = event.touches[0]?.clientX ?? 0;
          });

          slider.addEventListener("touchend", (event) => {
            if (!pointerActive) return;
            const endTouch = event.changedTouches[0];
            const deltaX = (endTouch?.clientX ?? 0) - pointerStartX;
            finalizeSwipe(deltaX);
            pointerActive = false;
          });

          slider.addEventListener("touchcancel", () => {
            pointerActive = false;
          });
        }

        goToSlide(0);
      }

      async function loadStoryConfig() {
        const response = await fetch(DATA_URL, { cache: "no-store" });

        if (!response.ok) {
          throw new Error(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu (${response.status})`);
        }

        return response.json();
      }

      function formatDate(value) {
        if (!value) {
          return "";
        }

        let dateObject = null;

        if (value instanceof Date) {
          dateObject = value;
        } else if (typeof value?.toDate === "function") {
          dateObject = value.toDate();
        } else if (typeof value === "object" && typeof value?.seconds === "number") {
          dateObject = new Date(value.seconds * 1000);
        } else {
          const stringValue = value.toString();
          const isoMatch = stringValue.match(/^(\d{4})-(\d{2})-(\d{2})$/);
          if (isoMatch) {
            return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;
          }

          const parsed = new Date(stringValue);
          if (!Number.isNaN(parsed.getTime())) {
            dateObject = parsed;
          } else {
            return escapeHtml(stringValue);
          }
        }

        if (!dateObject || Number.isNaN(dateObject.getTime())) {
          return "";
        }

        return `${padTwo(dateObject.getDate())}/${padTwo(dateObject.getMonth() + 1)}/${dateObject.getFullYear()}`;
      }

      function padTwo(value) {
        return value.toString().padStart(2, "0");
      }

      function applyConfig(config) {
        storyConfig = config;

        const {
          title,
          subtitle,
          startDate: startDateString,
          hero,
          people: { personA, personB } = {},
          timeline = [],
        } = config;

        const titleElement = document.getElementById("storyTitle");
        if (titleElement && title) {
          titleElement.textContent = title;
        }

        const subtitleElement = document.getElementById("storySubtitle");
        if (subtitleElement) {
          if (subtitle) {
            subtitleElement.textContent = subtitle;
            subtitleElement.hidden = false;
          } else {
            subtitleElement.hidden = true;
          }
        }

        const heroBanner = document.getElementById("heroBanner");
        const heroImage = document.getElementById("heroImage");
        if (heroBanner && heroImage) {
          if (hero?.image) {
            heroImage.src = hero.image;
            heroImage.alt = hero.alt || "Kho·∫£nh kh·∫Øc c·ªßa ch√∫ng ta";
            heroBanner.hidden = false;
          } else {
            heroBanner.hidden = true;
          }
        }

        const nameAElement = document.getElementById("nameA");
        const avatarAElement = document.getElementById("avatarA");
        const zodiacAElement = document.getElementById("zodiacA");
        if (personA && nameAElement && avatarAElement) {
          nameAElement.textContent = personA.name || "Ng∆∞·ªùi ·∫•y";
          if (personA.avatar) {
            avatarAElement.src = personA.avatar;
          }
          avatarAElement.alt = personA.name || "Ng∆∞·ªùi ·∫•y";
        }
        renderZodiacTag(zodiacAElement, personA?.zodiac);

        const nameBElement = document.getElementById("nameB");
        const avatarBElement = document.getElementById("avatarB");
        const zodiacBElement = document.getElementById("zodiacB");
        if (personB && nameBElement && avatarBElement) {
          nameBElement.textContent = personB.name || "Ng∆∞·ªùi ·∫•y";
          if (personB.avatar) {
            avatarBElement.src = personB.avatar;
          }
          avatarBElement.alt = personB.name || "Ng∆∞·ªùi ·∫•y";
        }
        renderZodiacTag(zodiacBElement, personB?.zodiac);

        if (startDateString) {
          document.getElementById("sinceDate").textContent = formatDate(startDateString);
          startDate = new Date(`${startDateString}T00:00:00`);
          startDate.setHours(0, 0, 0, 0);
        }

        timelineFallback = Array.isArray(timeline) ? timeline : [];

        if (!isFirebaseReady) {
          renderTimeline(timelineFallback);
        }
      }

      function isVideoMedia(media) {
        if (!media || !media.src) return false;
        const declaredType = media.type?.toLowerCase();
        if (declaredType === "video") return true;
        const videoExtensions = ["mp4", "webm", "ogg", "mov", "m4v"];
        const extension = media.src.split("?")[0].split(".").pop()?.toLowerCase();
        return extension ? videoExtensions.includes(extension) : false;
      }

      function renderMediaFigure(media, options = {}) {
        const { fallbackTitle = "", isPrimary = false } = options;
        if (!media || !media.src) return "";

        const isVideo = isVideoMedia(media);
        const captionText = media.caption || media.alt || fallbackTitle;
        const safeCaption = captionText ? escapeHtml(captionText) : "";
        const figureClass = isPrimary ? "timeline-card__media" : "timeline-card__gallery-item";

        const datasetAttributes = [
          'data-media-trigger="true"',
          `data-media-type="${isVideo ? "video" : "image"}"`,
          `data-media-src="${escapeAttribute(media.src)}"`,
        ];

        if (media.poster) {
          datasetAttributes.push(`data-media-poster="${escapeAttribute(media.poster)}"`);
        }

        if (media.mimeType) {
          datasetAttributes.push(`data-media-mime="${escapeAttribute(media.mimeType)}"`);
        }

        if (captionText) {
          datasetAttributes.push(`data-media-caption="${escapeAttribute(captionText)}"`);
        }

        const mediaContent = isVideo
          ? `<video playsinline preload="metadata" muted>
                <source src="${media.src}" ${media.mimeType ? `type="${media.mimeType}"` : ""} />
                Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
              </video>`
          : `<img src="${media.src}" alt="${escapeAttribute(media.alt || fallbackTitle)}" loading="lazy" />`;

        return `
          <figure class="${figureClass}" tabindex="0" ${datasetAttributes.join(" ")}>
            ${mediaContent}
            ${safeCaption ? `<figcaption class="timeline-card__caption${
              isPrimary ? "" : " timeline-card__caption--secondary"
            }">${safeCaption}</figcaption>` : ""}
          </figure>
        `;
      }

      function createTimelineGallery(mediaItems, fallbackTitle) {
        if (!Array.isArray(mediaItems) || mediaItems.length === 0) {
          return { main: "", gallery: "" };
        }

        const [primary, ...rest] = mediaItems;

        const main = renderMediaFigure(primary, { fallbackTitle, isPrimary: true });

        const gallery = rest.length
          ? `<div class="timeline-card__gallery">${rest
              .map((item) => renderMediaFigure(item, { fallbackTitle }))
              .join("")}</div>`
          : "";

        return { main, gallery };
      }

      function parseTimelineDate(value) {
        if (!value) {
          return Number.NaN;
        }

        if (value instanceof Date) {
          return value.getTime();
        }

        if (typeof value?.toDate === "function") {
          return value.toDate().getTime();
        }

        if (typeof value === "object" && typeof value?.seconds === "number") {
          return value.seconds * 1000;
        }

        const stringValue = value.toString();
        const isoMatch = stringValue.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (isoMatch) {
          return new Date(`${isoMatch[1]}-${isoMatch[2]}-${isoMatch[3]}T00:00:00`).getTime();
        }

        const parsed = new Date(stringValue);
        return parsed.getTime();
      }

      function sortTimelineEntries(entries = []) {
        return entries
          .slice()
          .sort((a, b) => {
            const timeA = parseTimelineDate(a?.date);
            const timeB = parseTimelineDate(b?.date);

            if (Number.isNaN(timeA) && Number.isNaN(timeB)) {
              return 0;
            }
            if (Number.isNaN(timeA)) {
              return 1;
            }
            if (Number.isNaN(timeB)) {
              return -1;
            }

            return timeA - timeB;
          });
      }

      function createTimelineCard(entry = {}) {
        const { id, date, title = "", description = "", location = "", images } = entry;
        const formattedDate = formatDate(date);
        const { main, gallery } = createTimelineGallery(images, title);
        const hasMainImage = Boolean(main);
        const cardClass = `timeline-card${hasMainImage ? "" : " timeline-card--compact"}`;
        const safeTitle = escapeHtml(title);
        const safeLocation = location ? escapeHtml(location) : "";
        const safeDescription = description
          ? escapeHtml(description).replace(/\n/g, "<br />")
          : "";
        const safeId = id ? escapeAttribute(id) : "";

        const addImageButton = timelineFormUnlocked && id
          ? `<button type="button" class="timeline-card__add-image-btn" data-timeline-id="${safeId}" aria-label="Th√™m ·∫£nh v√†o c·ªôt m·ªëc n√†y">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <span>Th√™m ·∫£nh</span>
            </button>`
          : "";

        return `
          <article class="${cardClass}" data-timeline-entry-id="${safeId}">
            ${main}
            <div class="timeline-card__body">
              ${
                formattedDate
                  ? `<span class="timeline-card__date">${formattedDate}</span>`
                  : ""
              }
              <h3 class="timeline-card__title">${safeTitle}</h3>
              ${
                safeLocation
                  ? `<span class="timeline-card__location">${safeLocation}</span>`
                  : ""
              }
              ${
                safeDescription
                  ? `<p class="timeline-card__description">${safeDescription}</p>`
                  : ""
              }
              ${gallery}
              ${addImageButton}
            </div>
          </article>
        `;
      }

      function renderTimeline(entries) {
        const grid = document.getElementById("timelineGrid");

        if (!grid) return;

        if (!Array.isArray(entries) || entries.length === 0) {
          grid.innerHTML =
            '<p class="timeline-empty">Ch∆∞a c√≥ c·ªôt m·ªëc n√†o ‚Äî c√πng nhau t·∫°o n√™n nh√©!</p>';
          return;
        }

        const orderedEntries = sortTimelineEntries(entries);
        grid.innerHTML = orderedEntries.map(createTimelineCard).join("");
        attachLightboxHandlers();
        attachAddImageHandlers();
      }

      function setTimelineSubmitSectionVisibility(isVisible) {
        if (!timelineSubmitSection) {
          return;
        }

        timelineSubmitSection.hidden = !isVisible;
        timelineSubmitSection.setAttribute("aria-hidden", (!isVisible).toString());
        timelineSubmitSection.classList.toggle("timeline-submit--visible", Boolean(isVisible));
      }

      function setTimelineFormEnabled(isEnabled) {
        if (!timelineForm) {
          return;
        }

        const elements = timelineForm.querySelectorAll("input, textarea, button");
        const enableForm = Boolean(isEnabled && timelineFormUnlocked);

        elements.forEach((element) => {
          element.disabled = !enableForm;
        });

        timelineForm.classList.toggle("timeline-form--disabled", !enableForm);
      }

      function setTimelineFormSubmitting(isSubmitting) {
        if (!timelineForm) {
          return;
        }

        timelineForm.classList.toggle("timeline-form--submitting", isSubmitting);

        if (timelineSubmitButton) {
          timelineSubmitButton.disabled = Boolean(isSubmitting);
          timelineSubmitButton.dataset.loading = isSubmitting ? "true" : "false";
        }
      }

      function focusTimelineFirstField() {
        // Focus v√†o date display input first
        const dateDisplay = document.getElementById("timelineDateDisplay");
        if (dateDisplay) {
          try {
            dateDisplay.focus({ preventScroll: true });
            return;
          } catch (error) {
            dateDisplay.focus();
            return;
          }
        }

        // Fallback to first input if date display not found
        if (!timelineForm) {
          return;
        }

        const candidate = timelineForm.querySelector("input, textarea, select");
        if (!candidate || typeof candidate.focus !== "function") {
          return;
        }

        try {
          candidate.focus({ preventScroll: true });
        } catch (error) {
          candidate.focus();
        }
      }

      function formatDateToDDMMYYYY(dateString) {
        if (!dateString) return "";
        const match = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (match) {
          return `${match[3]}/${match[2]}/${match[1]}`;
        }
        return dateString;
      }

      function updateDateDisplay() {
        const dateInput = document.getElementById("timelineDateInput");
        const dateDisplay = document.getElementById("timelineDateDisplay");
        if (!dateInput || !dateDisplay) return;

        const dateValue = dateInput.value;
        dateDisplay.value = formatDateToDDMMYYYY(dateValue);
      }

      function setTimelineDateToToday() {
        const dateInput = document.getElementById("timelineDateInput");
        if (!dateInput) {
          return;
        }

        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        dateInput.value = `${year}-${month}-${day}`;
        updateDateDisplay();
      }

      function setTimelineFormStatus(message, type = "info") {
        if (!timelineFormStatus) {
          return;
        }

        timelineFormStatus.textContent = message || "";
        const statusTypes = ["info", "success", "warning", "error", "pending"];
        statusTypes.forEach((statusType) => {
          timelineFormStatus.classList.toggle(
            `timeline-form__status--${statusType}`,
            statusType === type
          );
        });
      }

      function setTimelinePasswordStatus(message, type = "info") {
        if (!timelinePasswordStatus) {
          return;
        }

        timelinePasswordStatus.textContent = message || "";
        const statusTypes = ["info", "success", "warning", "error", "pending"];
        statusTypes.forEach((statusType) => {
          timelinePasswordStatus.classList.toggle(
            `timeline-form__status--${statusType}`,
            statusType === type
          );
        });
      }

      function openTimelinePasswordModal() {
        if (!timelinePasswordModal) {
          return;
        }

        timelinePasswordModal.hidden = false;
        timelinePasswordModal.classList.add("timeline-password-modal--open");
        document.body.classList.add("timeline-password-modal-open");
        setTimelinePasswordStatus("Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kh√≥a nh√© üåü", "info");

        window.requestAnimationFrame(() => {
          timelinePasswordInput?.focus();
        });
      }

      function closeTimelinePasswordModal(options = {}) {
        if (!timelinePasswordModal) {
          return;
        }

        timelinePasswordModal.classList.remove("timeline-password-modal--open");
        timelinePasswordModal.hidden = true;
        document.body.classList.remove("timeline-password-modal-open");
        timelinePasswordForm?.reset();
        setTimelinePasswordStatus("");

        if (!timelineFormUnlocked && options.restoreFocus !== false) {
          unlockHeart?.focus();
        }
      }

      function determineMediaTypeFromUrl(url = "") {
        const lowered = url.toLowerCase();
        const videoExtensions = [".mp4", ".webm", ".ogg", ".mov", ".m4v"];
        const imageExtensions = [".jpg", ".jpeg", ".png", ".gif", ".webp", ".avif"];

        if (videoExtensions.some((ext) => lowered.endsWith(ext))) {
          return "video";
        }

        if (imageExtensions.some((ext) => lowered.endsWith(ext))) {
          return "image";
        }

        return "auto";
      }

      function resetTimelineMediaSelections() {
        if (Array.isArray(timelineMediaSelections)) {
          timelineMediaSelections.forEach((selection) => {
            if (selection?.previewUrl) {
              URL.revokeObjectURL(selection.previewUrl);
            }
          });
        }

        timelineMediaSelections = [];

        if (timelineMediaPreviewList) {
          timelineMediaPreviewList.innerHTML = "";
        }

        if (timelineMediaPreviewContainer) {
          timelineMediaPreviewContainer.hidden = true;
        }

        if (timelineAddMoreMediaBtn) {
          timelineAddMoreMediaBtn.hidden = true;
        }
      }

      function autoResizeTextarea(textarea) {
        if (!textarea) return;
        textarea.style.height = "auto";
        const scrollHeight = textarea.scrollHeight;
        const minHeight = 42;
        const maxHeight = 200;
        textarea.style.height = `${Math.min(Math.max(scrollHeight, minHeight), maxHeight)}px`;
        textarea.style.overflowY = scrollHeight > maxHeight ? "auto" : "hidden";
      }

      function renderTimelineMediaPreview() {
        if (!timelineMediaPreviewList || !Array.isArray(timelineMediaSelections)) {
          return;
        }

        timelineMediaPreviewList.innerHTML = "";

        timelineMediaSelections.forEach((selection, index) => {
          const { file, previewUrl, captionInput, type } = selection;
          const isVideo = type === "video";

          const item = document.createElement("div");
          item.className = `timeline-media-preview__item ${
            isVideo ? "timeline-media-preview__item--video" : "timeline-media-preview__item--image"
          }`;
          item.dataset.mediaIndex = String(index);
          item.draggable = true;

          const headerRow = document.createElement("div");
          headerRow.className = "timeline-media-preview__header";

          const badge = document.createElement("span");
          badge.className = "timeline-media-preview__badge";
          badge.textContent = index === 0 ? "·∫¢nh ƒë·∫°i di·ªán" : `·∫¢nh ${index + 1}`;

          const controls = document.createElement("div");
          controls.className = "timeline-media-preview__controls";

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "timeline-media-preview__delete-btn";
          deleteBtn.innerHTML = "√ó";
          deleteBtn.title = "X√≥a ·∫£nh n√†y";
          deleteBtn.setAttribute("aria-label", "X√≥a ·∫£nh n√†y");
          deleteBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (selection?.previewUrl) {
              URL.revokeObjectURL(selection.previewUrl);
            }
            timelineMediaSelections.splice(index, 1);
            if (timelineMediaSelections.length === 0) {
              if (timelineMediaPreviewList) {
                timelineMediaPreviewList.innerHTML = "";
              }
              if (timelineMediaPreviewContainer) {
                timelineMediaPreviewContainer.hidden = true;
              }
              if (timelineAddMoreMediaBtn) {
                timelineAddMoreMediaBtn.hidden = true;
              }
            } else {
              renderTimelineMediaPreview();
            }
          });
          controls.appendChild(deleteBtn);

          if (index > 0) {
            const upBtn = document.createElement("button");
            upBtn.type = "button";
            upBtn.className = "timeline-media-preview__move-btn";
            upBtn.innerHTML = "‚Üë";
            upBtn.title = "Di chuy·ªÉn l√™n";
            upBtn.addEventListener("click", () => {
              const temp = timelineMediaSelections[index];
              timelineMediaSelections[index] = timelineMediaSelections[index - 1];
              timelineMediaSelections[index - 1] = temp;
              renderTimelineMediaPreview();
            });
            controls.appendChild(upBtn);
          }

          if (index < timelineMediaSelections.length - 1) {
            const downBtn = document.createElement("button");
            downBtn.type = "button";
            downBtn.className = "timeline-media-preview__move-btn";
            downBtn.innerHTML = "‚Üì";
            downBtn.title = "Di chuy·ªÉn xu·ªëng";
            downBtn.addEventListener("click", () => {
              const temp = timelineMediaSelections[index];
              timelineMediaSelections[index] = timelineMediaSelections[index + 1];
              timelineMediaSelections[index + 1] = temp;
              renderTimelineMediaPreview();
            });
            controls.appendChild(downBtn);
          }

          headerRow.appendChild(badge);
          headerRow.appendChild(controls);
          item.appendChild(headerRow);

          const mediaWrapper = document.createElement(isVideo ? "video" : "img");
          mediaWrapper.className = "timeline-media-preview__media";
          mediaWrapper.style.cursor = "pointer";
          mediaWrapper.title = "Click ƒë·ªÉ xem chi ti·∫øt";
          if (isVideo) {
            mediaWrapper.src = previewUrl;
            mediaWrapper.controls = true;
            mediaWrapper.preload = "metadata";
          } else {
            mediaWrapper.src = previewUrl;
            mediaWrapper.alt = file.name || `File ${index + 1}`;
          }

          // Add click handler to open lightbox
          mediaWrapper.addEventListener("click", (e) => {
            // Prevent drag events from triggering lightbox
            if (item.classList.contains("timeline-media-preview__item--dragging")) {
              return;
            }

            e.stopPropagation();
            const captionValue = selection?.captionInput?.value?.trim() || "";
            const captionText = captionValue || file.name || (index === 0 ? "·∫¢nh ƒë·∫°i di·ªán" : `·∫¢nh ${index + 1}`);

            if (typeof openLightbox === "function") {
              openLightbox({
                type: isVideo ? "video" : "image",
                src: previewUrl,
                caption: captionText,
                mime: file.type || "",
              });
            }
          });

          const meta = document.createElement("p");
          meta.className = "timeline-media-preview__name";
          meta.textContent = file.name || `File ${index + 1}`;

          const captionLabel = document.createElement("label");
          captionLabel.className = "timeline-media-preview__caption";

          const captionTitle = document.createElement("span");
          captionTitle.textContent = `Ch√∫ th√≠ch${index === 0 ? " (·∫¢nh ƒë·∫°i di·ªán)" : ""}`;

          if (!captionInput || !captionInput.parentElement) {
            const newCaptionInput = document.createElement("textarea");
            newCaptionInput.maxLength = 160;
            newCaptionInput.placeholder = "Nh·∫≠p ch√∫ th√≠ch cho h√¨nh/video n√†y";
            newCaptionInput.className = "timeline-media-preview__caption-input";
            newCaptionInput.rows = 1;
            newCaptionInput.addEventListener("input", () => {
              autoResizeTextarea(newCaptionInput);
            });
            selection.captionInput = newCaptionInput;
            captionLabel.appendChild(captionTitle);
            captionLabel.appendChild(newCaptionInput);
            autoResizeTextarea(newCaptionInput);
          } else {
            if (!captionInput.hasAttribute("rows")) {
              captionInput.setAttribute("rows", "1");
            }
            if (captionInput.tagName.toLowerCase() !== "textarea") {
              const textarea = document.createElement("textarea");
              textarea.value = captionInput.value || "";
              textarea.maxLength = 160;
              textarea.placeholder = "Nh·∫≠p ch√∫ th√≠ch cho h√¨nh/video n√†y";
              textarea.className = "timeline-media-preview__caption-input";
              textarea.rows = 1;
              textarea.addEventListener("input", () => {
                autoResizeTextarea(textarea);
              });
              selection.captionInput = textarea;
              captionLabel.appendChild(captionTitle);
              captionLabel.appendChild(textarea);
              autoResizeTextarea(textarea);
            } else {
              captionLabel.appendChild(captionTitle);
              captionLabel.appendChild(captionInput);
              if (!captionInput.oninput) {
                captionInput.addEventListener("input", () => {
                  autoResizeTextarea(captionInput);
                });
              }
              autoResizeTextarea(captionInput);
            }
          }

          item.addEventListener("dragstart", (e) => {
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData("text/html", item.outerHTML);
            e.dataTransfer.setData("text/plain", String(index));
            item.classList.add("timeline-media-preview__item--dragging");
          });

          item.addEventListener("dragend", () => {
            item.classList.remove("timeline-media-preview__item--dragging");
          });

          item.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
          });

          item.addEventListener("drop", (e) => {
            e.preventDefault();
            const fromIndex = Number.parseInt(e.dataTransfer.getData("text/plain"), 10);
            const toIndex = index;

            if (fromIndex !== toIndex && !Number.isNaN(fromIndex)) {
              const moved = timelineMediaSelections.splice(fromIndex, 1)[0];
              timelineMediaSelections.splice(toIndex, 0, moved);
              renderTimelineMediaPreview();
            }
          });

          item.appendChild(mediaWrapper);
          item.appendChild(meta);
          item.appendChild(captionLabel);

          timelineMediaPreviewList.appendChild(item);
        });
      }

      function handleTimelineMediaSelection(event) {
        const files = Array.from(event?.target?.files || []);

        if (!files.length || !timelineMediaPreviewContainer || !timelineMediaPreviewList) {
          return;
        }

        if (!Array.isArray(timelineMediaSelections)) {
          timelineMediaSelections = [];
        }

        timelineMediaPreviewContainer.hidden = false;

        const newSelections = files.map((file) => {
          const previewUrl = URL.createObjectURL(file);
          const isVideo = file.type?.toLowerCase().startsWith("video/");

          const captionInput = document.createElement("textarea");
          captionInput.maxLength = 160;
          captionInput.placeholder = "Nh·∫≠p ch√∫ th√≠ch cho h√¨nh/video n√†y";
          captionInput.className = "timeline-media-preview__caption-input";
          captionInput.rows = 1;
          captionInput.addEventListener("input", () => {
            autoResizeTextarea(captionInput);
          });

          return {
            file,
            previewUrl,
            captionInput,
            type: isVideo ? "video" : "image",
          };
        });

        timelineMediaSelections.push(...newSelections);
        renderTimelineMediaPreview();

        if (timelineAddMoreMediaBtn) {
          timelineAddMoreMediaBtn.hidden = false;
        }

        if (timelineMediaFileInput) {
          timelineMediaFileInput.value = "";
        }
      }

      function handleAddMoreMediaClick() {
        if (timelineMediaFileInput) {
          timelineMediaFileInput.click();
        }
      }

      function sanitizeStorageFileName(name = "") {
        return name
          .split("/")
          .pop()
          ?.replace(/[^a-z0-9._-]+/gi, "_")
          ?.replace(/_+/g, "_")
          ?.replace(/^_+|_+$/g, "")
          ?.slice(0, 120) || "media";
      }

      async function uploadTimelineMediaFile(file, context = {}) {
        if (!storage) {
          throw new Error("Firebase Storage ch∆∞a s·∫µn s√†ng ƒë·ªÉ t·∫£i file.");
        }

        const { title = "", caption = "" } = context;
        const sanitizedName = sanitizeStorageFileName(file.name || "media");
        const timestamp = Date.now();
        const storagePath = `${STORAGE_UPLOAD_FOLDER}/${timestamp}_${sanitizedName}`;

        const fileRef = storage.ref().child(storagePath);
        const metadata = {
          contentType: file.type || "application/octet-stream",
        };

        await fileRef.put(file, metadata);
        const downloadURL = await fileRef.getDownloadURL();

        const inferredType = file.type?.startsWith("video/") ? "video" : "image";

        return {
          src: downloadURL,
          type: inferredType,
          caption: caption,
          alt: caption || title || sanitizedName,
          mimeType: file.type || "",
        };
      }

      function normalizeTimelineMediaItem(item = {}, fallbackTitle = "") {
        if (!item) {
          return null;
        }

        const src = item.src || item.url;
        if (!src) {
          return null;
        }

        const type = item.type || determineMediaTypeFromUrl(src);
        return {
          src,
          alt: item.alt || item.caption || fallbackTitle,
          caption: item.caption || item.alt || "",
          type: type === "auto" ? undefined : type,
          poster: item.poster || "",
          mimeType: item.mimeType || item.mediaType || "",
        };
      }

      function normalizeFirestoreTimelineEntry(doc) {
        const raw = typeof doc?.data === "function" ? doc.data() : {};

        const fallbackTitle = raw?.title || "C·ªôt m·ªëc y√™u th∆∞∆°ng";
        const images = Array.isArray(raw?.images)
          ? raw.images
              .map((item) => normalizeTimelineMediaItem(item, fallbackTitle))
              .filter(Boolean)
          : [];

        return {
          id: doc?.id,
          date: raw?.date,
          title: fallbackTitle,
          location: raw?.location || "",
          description: raw?.description || "",
          images,
        };
      }

      function subscribeToTimelineCollection() {
        if (!firestore) {
          return;
        }

        if (typeof timelineUnsubscribe === "function") {
          timelineUnsubscribe();
        }

        const collectionRef = firestore
          .collection(TIMELINE_COLLECTION)
          .orderBy("date", "asc");

        timelineUnsubscribe = collectionRef.onSnapshot(
          (snapshot) => {
            const entries = snapshot.docs.map((doc) => normalizeFirestoreTimelineEntry(doc));

            if (entries.length > 0) {
              renderTimeline(entries);
            } else if (timelineFallback.length > 0) {
              renderTimeline(timelineFallback);
            } else {
              renderTimeline([]);
            }

            if (timelineFormUnlocked) {
              if (entries.length === 0) {
                setTimelineFormStatus(
                  "H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n k·ªÉ th√™m m·ªôt k·ª∑ ni·ªám üíå",
                  "info"
                );
              } else {
                setTimelineFormStatus("K·ªÉ th√™m c·ªôt m·ªëc m·ªõi nh√© üíñ", "success");
              }
            } else {
              setTimelineFormStatus("");
              setTimelinePasswordStatus("Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kh√≥a nh√© üåü", "info");
            }
          },
          (error) => {
            console.error(error);
            setTimelineFormStatus(
              "Kh√¥ng th·ªÉ t·∫£i c·ªôt m·ªëc m·ªõi t·ª´ Firebase. ƒêang hi·ªÉn th·ªã d·ªØ li·ªáu d·ª± ph√≤ng.",
              "warning"
            );
            renderTimeline(timelineFallback);
          }
        );
      }

      function buildTimelineEntryFromForm(formData, options = {}) {
        const { appendedMedia = [] } = options;
        const title = (formData.get("title") || "").trim();
        const dateValue = (formData.get("date") || "").trim();
        const description = (formData.get("description") || "").trim();
        const location = (formData.get("location") || "").trim();

        if (!title || !dateValue) {
          throw new Error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß ng√†y v√† ti√™u ƒë·ªÅ cho c·ªôt m·ªëc.");
        }

        const isoDate = dateValue;
        const images = Array.isArray(appendedMedia)
          ? appendedMedia
              .filter(Boolean)
              .map((item) => ({
                src: item.src,
                type: item.type,
                caption: item.caption || "",
                alt: item.alt || title,
                poster: item.poster || "",
                mimeType: item.mimeType || "",
              }))
          : [];

        return {
          title,
          date: isoDate,
          location,
          description,
          images,
        };
      }

      async function handleTimelineSubmit(event) {
        event.preventDefault();

        if (!timelineForm) {
          return;
        }

        if (!timelineFormUnlocked) {
          setTimelinePasswordStatus("Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kh√≥a nh√© üåü", "info");
          setTimelineFormStatus(
            "B·∫°n c·∫ßn m·ªü kh√≥a b·∫±ng m·∫≠t kh·∫©u tr∆∞·ªõc khi g·ª≠i c·ªôt m·ªëc nha üíñ",
            "warning"
          );
          return;
        }

        if (!firestore) {
          setTimelineFormStatus(
            "Ch·ª©c nƒÉng th√™m c·ªôt m·ªëc ƒëang ƒë∆∞·ª£c thi·∫øt l·∫≠p. Vui l√≤ng quay l·∫°i sau nh√©!",
            "warning"
          );
          return;
        }

        const formData = new FormData(timelineForm);
        const selectedMedia = Array.isArray(timelineMediaSelections)
          ? timelineMediaSelections.slice()
          : [];
        const titleValue = (formData.get("title") || "").trim();

        if (selectedMedia.length && !storage) {
          setTimelineFormStatus(
            "Kh√¥ng th·ªÉ t·∫£i file v√¨ Firebase Storage ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.",
            "error"
          );
          return;
        }

        const oversizedSelection = selectedMedia.find(
          (selection) => selection?.file?.size > MAX_UPLOAD_SIZE_BYTES
        );

        if (oversizedSelection) {
          const fileSizeMb = (
            oversizedSelection.file.size /
            (1024 * 1024)
          ).toFixed(1);
          const maxSizeMb = (MAX_UPLOAD_SIZE_BYTES / (1024 * 1024)).toFixed(0);
          setTimelineFormStatus(
            `File ${oversizedSelection.file.name || ""} qu√° l·ªõn (${fileSizeMb}MB). Vui l√≤ng ch·ªçn file nh·ªè h∆°n ${maxSizeMb}MB.`,
            "error"
          );
          return;
        }

        try {
          setTimelineFormSubmitting(true);
          let appendedMedia = [];

          if (selectedMedia.length) {
            for (let index = 0; index < selectedMedia.length; index += 1) {
              const selection = selectedMedia[index];
              const captionValue = selection?.captionInput?.value?.trim() || "";

              setTimelineFormStatus(
                selectedMedia.length === 1
                  ? "ƒêang t·∫£i file l√™n b·ªô nh·ªõ y√™u th∆∞∆°ng..."
                  : `ƒêang t·∫£i file ${index + 1}/${selectedMedia.length} v√†o b·ªô nh·ªõ y√™u th∆∞∆°ng...`,
                "pending"
              );

              const uploadedMedia = await uploadTimelineMediaFile(selection.file, {
                title: titleValue,
                caption: captionValue,
              });

              appendedMedia.push({
                ...uploadedMedia,
                caption: captionValue || uploadedMedia.caption,
                alt: captionValue || uploadedMedia.alt,
              });
            }
          }

          const entry = buildTimelineEntryFromForm(formData, { appendedMedia });
          setTimelineFormStatus("ƒêang g·ª≠i c·ªôt m·ªëc nh·ªè xinh c·ªßa b·∫°n...", "pending");
          await firestore.collection(TIMELINE_COLLECTION).add({
            ...entry,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          timelineForm.reset();
          if (timelineMediaFileInput) {
            timelineMediaFileInput.value = "";
          }
          resetTimelineMediaSelections();
          setTimelineFormStatus("ƒê√£ g·ª≠i th√†nh c√¥ng! Y√™u th∆∞∆°ng ƒë√£ ƒë∆∞·ª£c l∆∞u l·∫°i üíï", "success");
        } catch (error) {
          console.error(error);
          setTimelineFormStatus(
            `G·ª≠i c·ªôt m·ªëc ch∆∞a th√†nh c√¥ng: ${error?.message || String(error)}`,
            "error"
          );
        } finally {
          setTimelineFormSubmitting(false);
        }
      }

      function handleTimelinePasswordSubmit(event) {
        event.preventDefault();

        if (!timelinePasswordInput) {
          return;
        }

        const submittedPassword = timelinePasswordInput.value.trim();

        if (submittedPassword !== TIMELINE_FORM_PASSWORD) {
          setTimelinePasswordStatus("Sai m·∫≠t kh·∫©u r·ªìi, th·ª≠ l·∫°i nh√© üíî", "error");
          timelinePasswordInput.value = "";
          timelinePasswordInput.focus();
          return;
        }

        timelineFormUnlocked = true;
        // L∆∞u tr·∫°ng th√°i unlock v√†o localStorage
        localStorage.setItem("timelineFormUnlocked", "true");
        setTimelineSubmitSectionVisibility(true);
        timelinePasswordInput.value = "";

        if (timelineForm) {
          timelineForm.hidden = false;
          setTimelineDateToToday();
        }

        if (isFirebaseReady) {
          setTimelineFormEnabled(true);
          setTimelineFormStatus("K·ªÉ th√™m c·ªôt m·ªëc m·ªõi nh√© üíñ", "success");
        } else {
          setTimelineFormEnabled(false);
          setTimelineFormStatus("ƒêang k·∫øt n·ªëi Firebase, vui l√≤ng ch·ªù nh√©...", "pending");
        }

        closeTimelinePasswordModal({ restoreFocus: false });
        unlockHeart?.classList.add("heart--unlocked");
        
        // Re-render timeline ƒë·ªÉ hi·ªÉn th·ªã n√∫t "Th√™m ·∫£nh" sau khi unlock
        setTimeout(() => {
          const grid = document.getElementById("timelineGrid");
          if (grid) {
            const existingCards = grid.querySelectorAll("article");
            if (existingCards.length > 0) {
              // L·∫•y l·∫°i entries hi·ªán t·∫°i v√† re-render
              if (firestore) {
                // Timeline s·∫Ω t·ª± ƒë·ªông re-render qua onSnapshot listener
                // Nh∆∞ng ƒë·ªÉ ƒë·∫£m b·∫£o, trigger m·ªôt l·∫ßn n·ªØa
                subscribeToTimelineCollection();
              } else if (timelineFallback.length > 0) {
                // Fallback: re-render v·ªõi fallback data
                renderTimeline(timelineFallback);
              }
            }
          }
        }, 100);

        // Sau khi unlock, m·ªü heart menu modal
        setTimeout(() => {
          openHeartMenuModal();
        }, 300);
      }

      function openHeartMenuModal() {
        const modal = document.getElementById("heartMenuModal");
        if (!modal) {
          return;
        }

        modal.hidden = false;
        modal.classList.add("heart-menu-modal--open");
        document.body.classList.add("heart-menu-modal-open");
      }

      function closeHeartMenuModal() {
        const modal = document.getElementById("heartMenuModal");
        if (!modal) {
          return;
        }

        modal.classList.remove("heart-menu-modal--open");
        modal.hidden = true;
        document.body.classList.remove("heart-menu-modal-open");
      }

      function navigateToPage(page) {
        closeHeartMenuModal();
        
        if (page === "todo") {
          // L∆∞u tr·∫°ng th√°i unlock v√†o localStorage
          if (timelineFormUnlocked) {
            localStorage.setItem("timelineFormUnlocked", "true");
          }
          // Chuy·ªÉn ƒë·∫øn trang todo
          window.location.href = "vieccanlam.html";
        } else if (page === "timeline") {
          // M·ªü timeline section v√† scroll ƒë·∫øn ƒë√≥
          const timelineSection = document.getElementById("timelineSection");
          const timelineToggle = document.getElementById("timelineToggle");
          if (timelineSection && timelineToggle) {
            if (!timelineSection.classList.contains("open")) {
              timelineSection.classList.add("open");
              timelineSection.setAttribute("aria-hidden", "false");
              timelineToggle.textContent = "·∫®n c·ªôt m·ªëc y√™u th∆∞∆°ng";
            }
            setTimeout(() => {
              timelineSection.scrollIntoView({ behavior: "smooth", block: "start" });
              // N·∫øu ƒë√£ unlock, scroll ƒë·∫øn form submit
              if (timelineFormUnlocked) {
                setTimeout(() => {
                  const timelineSubmitSection = document.getElementById("timelineSubmitSection");
                  if (timelineSubmitSection) {
                    timelineSubmitSection.scrollIntoView({ behavior: "smooth", block: "center" });
                  }
                }, 500);
              }
            }, 100);
          }
        }
      }

      function handleHeartActivation(event) {
        if (
          event.type === "keydown" &&
          event.key !== "Enter" &&
          event.key !== " " &&
          event.key !== "Spacebar"
        ) {
          return;
        }

        event.preventDefault();

        // N·∫øu ch∆∞a unlock, m·ªü password modal tr∆∞·ªõc
        if (!timelineFormUnlocked) {
          openTimelinePasswordModal();
          return;
        }

        // N·∫øu ƒë√£ unlock, m·ªü heart menu modal
        openHeartMenuModal();
      }

      function initFirebaseTimeline() {
        if (!timelineSubmitSection) {
          return;
        }

        setTimelineSubmitSectionVisibility(timelineFormUnlocked);

        if (!window.firebase) {
          setTimelineFormEnabled(false);
          setTimelineFormStatus(
            "Kh√¥ng th·ªÉ t·∫£i Firebase SDK. Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ th·ª≠ l·∫°i nh√©!",
            "error"
          );
          if (timelinePasswordForm) {
            timelinePasswordForm.hidden = false;
          }
          return;
        }

        if (!window.FIREBASE_CONFIG) {
          setTimelineFormEnabled(false);
          setTimelineFormStatus(
            "Ch·ª©c nƒÉng th√™m c·ªôt m·ªëc s·∫Ω ho·∫°t ƒë·ªông sau khi c·∫•u h√¨nh Firebase.",
            "warning"
          );
          if (timelinePasswordForm) {
            timelinePasswordForm.hidden = false;
          }
          return;
        }

        try {
          if (!firebase.apps.length) {
            firebase.initializeApp(window.FIREBASE_CONFIG);
          }
          firestore = firebase.firestore();
          if (typeof firebase.storage === "function") {
            storage = firebase.storage();
          } else {
            storage = null;
            console.warn("Firebase Storage SDK ch∆∞a ƒë∆∞·ª£c t·∫£i.");
          }
          isFirebaseReady = true;
          
          // Ki·ªÉm tra localStorage ƒë·ªÉ kh√¥i ph·ª•c tr·∫°ng th√°i unlock
          const savedUnlock = localStorage.getItem("timelineFormUnlocked");
          if (savedUnlock === "true") {
            timelineFormUnlocked = true;
            unlockHeart?.classList.add("heart--unlocked");
            setTimelineSubmitSectionVisibility(true);
            if (timelineForm) {
              timelineForm.hidden = false;
            }
          }
          
          if (timelineFormUnlocked) {
            setTimelineFormEnabled(true);
            setTimelineFormStatus("K·ªÉ th√™m c·ªôt m·ªëc m·ªõi nh√© üíñ", "success");
          } else {
            setTimelineFormEnabled(false);
            setTimelineFormStatus("Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kh√≥a nh√© üåü", "info");
            if (timelinePasswordForm) {
              timelinePasswordForm.hidden = false;
            }
            setTimelinePasswordStatus("Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kh√≥a nh√© üåü", "info");
          }
          subscribeToTimelineCollection();
        } catch (error) {
          console.error(error);
          setTimelineFormEnabled(false);
          setTimelineFormStatus(
            "Kh√¥ng th·ªÉ kh·ªüi t·∫°o Firebase. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh.",
            "error"
          );
          if (timelinePasswordForm) {
            timelinePasswordForm.hidden = false;
          }
        }
      }

      function openLightbox({ type, src, poster, caption, mime }) {
        if (!lightboxElement || !lightboxMediaContainer) return;

        lightboxMediaContainer.innerHTML = "";

        let mediaElement;
        if (type === "video") {
          mediaElement = document.createElement("video");
          mediaElement.controls = true;
          mediaElement.autoplay = true;
          mediaElement.playsInline = true;
          mediaElement.preload = "metadata";
          if (poster) {
            mediaElement.poster = poster;
          }

          const source = document.createElement("source");
          source.src = src;
          if (mime) {
            source.type = mime;
          }
          mediaElement.appendChild(source);
        } else {
          mediaElement = document.createElement("img");
          mediaElement.src = src;
          mediaElement.alt = caption || "";
        }

        lightboxMediaContainer.appendChild(mediaElement);

        if (lightboxCaptionElement) {
          if (caption) {
            lightboxCaptionElement.textContent = caption;
            lightboxCaptionElement.classList.remove("lightbox__caption--hidden");
          } else {
            lightboxCaptionElement.textContent = "";
            lightboxCaptionElement.classList.add("lightbox__caption--hidden");
          }
        }

        lightboxElement.removeAttribute("hidden");
        lightboxElement.classList.add("lightbox--open");
        document.body.classList.add("lightbox-open");

        const closeButton = lightboxElement.querySelector(".lightbox__close");
        closeButton?.focus();
      }

      function closeLightbox() {
        if (!lightboxElement || !lightboxElement.classList.contains("lightbox--open")) {
          return;
        }

        const activeVideo = lightboxMediaContainer?.querySelector("video");
        if (activeVideo) {
          activeVideo.pause();
          activeVideo.removeAttribute("src");
          activeVideo.load();
        }

        if (lightboxMediaContainer) {
          lightboxMediaContainer.innerHTML = "";
        }

        lightboxElement.classList.remove("lightbox--open");
        lightboxElement.setAttribute("hidden", "");
        document.body.classList.remove("lightbox-open");

        if (lastFocusedMediaTrigger) {
          lastFocusedMediaTrigger.focus();
        }
      }

      function handleMediaTriggerActivation(trigger) {
        if (!trigger) return;
        lastFocusedMediaTrigger = trigger;

        openLightbox({
          type: trigger.dataset.mediaType,
          src: trigger.dataset.mediaSrc,
          poster: trigger.dataset.mediaPoster,
          caption: trigger.dataset.mediaCaption,
          mime: trigger.dataset.mediaMime,
        });
      }

      function handleMediaTriggerClick(event) {
        event.preventDefault();
        handleMediaTriggerActivation(event.currentTarget);
      }

      function handleMediaTriggerKeydown(event) {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          handleMediaTriggerActivation(event.currentTarget);
        }
      }

      function attachLightboxHandlers() {
        const triggers = document.querySelectorAll(LIGHTBOX_TRIGGER_SELECTOR);
        triggers.forEach((trigger) => {
          if (trigger.dataset.lightboxBound === "true") {
            return;
          }

          trigger.dataset.lightboxBound = "true";
          trigger.addEventListener("click", handleMediaTriggerClick);
          trigger.addEventListener("keydown", handleMediaTriggerKeydown);
        });
      }

      function resetTimelineAddImageSelections() {
        if (Array.isArray(timelineAddImageSelections)) {
          timelineAddImageSelections.forEach((selection) => {
            if (selection?.previewUrl) {
              URL.revokeObjectURL(selection.previewUrl);
            }
          });
        }

        timelineAddImageSelections = [];

        const previewList = document.getElementById("timelineAddImagePreviewList");
        if (previewList) {
          previewList.innerHTML = "";
        }

        const previewContainer = document.getElementById("timelineAddImagePreviewContainer");
        if (previewContainer) {
          previewContainer.hidden = true;
        }

        const addMoreBtn = document.getElementById("timelineAddImageMoreBtn");
        if (addMoreBtn) {
          addMoreBtn.hidden = true;
        }
      }

      function renderTimelineAddImagePreview() {
        const previewList = document.getElementById("timelineAddImagePreviewList");
        if (!previewList || !Array.isArray(timelineAddImageSelections)) {
          return;
        }

        previewList.innerHTML = "";

        timelineAddImageSelections.forEach((selection, index) => {
          const { file, previewUrl, captionInput, type } = selection;
          const isVideo = type === "video";

          const item = document.createElement("div");
          item.className = `timeline-media-preview__item ${
            isVideo ? "timeline-media-preview__item--video" : "timeline-media-preview__item--image"
          }`;
          item.dataset.mediaIndex = String(index);

          const headerRow = document.createElement("div");
          headerRow.className = "timeline-media-preview__header";

          const badge = document.createElement("span");
          badge.className = "timeline-media-preview__badge";
          badge.textContent = `·∫¢nh ${index + 1}`;

          const controls = document.createElement("div");
          controls.className = "timeline-media-preview__controls";

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "timeline-media-preview__delete-btn";
          deleteBtn.innerHTML = "√ó";
          deleteBtn.title = "X√≥a ·∫£nh n√†y";
          deleteBtn.setAttribute("aria-label", "X√≥a ·∫£nh n√†y");
          deleteBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (selection?.previewUrl) {
              URL.revokeObjectURL(selection.previewUrl);
            }
            timelineAddImageSelections.splice(index, 1);
            if (timelineAddImageSelections.length === 0) {
              resetTimelineAddImageSelections();
            } else {
              renderTimelineAddImagePreview();
            }
          });
          controls.appendChild(deleteBtn);
          headerRow.appendChild(badge);
          headerRow.appendChild(controls);
          item.appendChild(headerRow);

          const mediaWrapper = document.createElement(isVideo ? "video" : "img");
          mediaWrapper.className = "timeline-media-preview__media";
          if (isVideo) {
            mediaWrapper.src = previewUrl;
            mediaWrapper.controls = true;
            mediaWrapper.preload = "metadata";
          } else {
            mediaWrapper.src = previewUrl;
            mediaWrapper.alt = file.name || `File ${index + 1}`;
          }

          const meta = document.createElement("p");
          meta.className = "timeline-media-preview__name";
          meta.textContent = file.name || `File ${index + 1}`;

          const captionLabel = document.createElement("label");
          captionLabel.className = "timeline-media-preview__caption";

          const captionTitle = document.createElement("span");
          captionTitle.textContent = "Ch√∫ th√≠ch";

          if (!captionInput || !captionInput.parentElement) {
            const newCaptionInput = document.createElement("textarea");
            newCaptionInput.maxLength = 160;
            newCaptionInput.placeholder = "Nh·∫≠p ch√∫ th√≠ch cho h√¨nh/video n√†y";
            newCaptionInput.className = "timeline-media-preview__caption-input";
            newCaptionInput.rows = 1;
            newCaptionInput.addEventListener("input", () => {
              autoResizeTextarea(newCaptionInput);
            });
            selection.captionInput = newCaptionInput;
            captionLabel.appendChild(captionTitle);
            captionLabel.appendChild(newCaptionInput);
            autoResizeTextarea(newCaptionInput);
          } else {
            captionLabel.appendChild(captionTitle);
            captionLabel.appendChild(captionInput);
            autoResizeTextarea(captionInput);
          }

          item.appendChild(mediaWrapper);
          item.appendChild(meta);
          item.appendChild(captionLabel);

          previewList.appendChild(item);
        });
      }

      function handleTimelineAddImageSelection(event) {
        const files = Array.from(event?.target?.files || []);
        const previewContainer = document.getElementById("timelineAddImagePreviewContainer");
        const previewList = document.getElementById("timelineAddImagePreviewList");

        if (!files.length || !previewContainer || !previewList) {
          return;
        }

        if (!Array.isArray(timelineAddImageSelections)) {
          timelineAddImageSelections = [];
        }

        previewContainer.hidden = false;

        const newSelections = files.map((file) => {
          const previewUrl = URL.createObjectURL(file);
          const isVideo = file.type?.toLowerCase().startsWith("video/");

          const captionInput = document.createElement("textarea");
          captionInput.maxLength = 160;
          captionInput.placeholder = "Nh·∫≠p ch√∫ th√≠ch cho h√¨nh/video n√†y";
          captionInput.className = "timeline-media-preview__caption-input";
          captionInput.rows = 1;
          captionInput.addEventListener("input", () => {
            autoResizeTextarea(captionInput);
          });

          return {
            file,
            previewUrl,
            captionInput,
            type: isVideo ? "video" : "image",
          };
        });

        timelineAddImageSelections.push(...newSelections);
        renderTimelineAddImagePreview();

        const addMoreBtn = document.getElementById("timelineAddImageMoreBtn");
        if (addMoreBtn) {
          addMoreBtn.hidden = false;
        }

        const fileInput = document.getElementById("timelineAddImageFile");
        if (fileInput) {
          fileInput.value = "";
        }
      }

      function handleAddMoreImageClick() {
        const fileInput = document.getElementById("timelineAddImageFile");
        if (fileInput) {
          fileInput.click();
        }
      }

      function openTimelineAddImageModal(timelineId) {
        const modal = document.getElementById("timelineAddImageModal");
        if (!modal) {
          return;
        }

        currentTimelineEntryId = timelineId;
        modal.hidden = false;
        modal.classList.add("timeline-add-image-modal--open");
        document.body.classList.add("timeline-add-image-modal-open");

        const status = document.getElementById("timelineAddImageStatus");
        if (status) {
          status.textContent = "";
        }

        resetTimelineAddImageSelections();

        const fileInput = document.getElementById("timelineAddImageFile");
        if (fileInput) {
          fileInput.value = "";
        }
      }

      function closeTimelineAddImageModal() {
        const modal = document.getElementById("timelineAddImageModal");
        if (!modal) {
          return;
        }

        modal.classList.remove("timeline-add-image-modal--open");
        modal.hidden = true;
        document.body.classList.remove("timeline-add-image-modal-open");

        resetTimelineAddImageSelections();
        currentTimelineEntryId = null;

        const form = document.getElementById("timelineAddImageForm");
        if (form) {
          form.reset();
        }

        const status = document.getElementById("timelineAddImageStatus");
        if (status) {
          status.textContent = "";
        }
      }

      async function handleTimelineAddImageSubmit(event) {
        event.preventDefault();

        if (!currentTimelineEntryId || !firestore) {
          const status = document.getElementById("timelineAddImageStatus");
          if (status) {
            status.textContent = "Kh√¥ng th·ªÉ th√™m ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i sau.";
            status.className = "timeline-form__status timeline-form__status--error";
          }
          return;
        }

        const selectedMedia = Array.isArray(timelineAddImageSelections)
          ? timelineAddImageSelections.slice()
          : [];

        if (selectedMedia.length === 0) {
          const status = document.getElementById("timelineAddImageStatus");
          if (status) {
            status.textContent = "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ·∫£nh ho·∫∑c video.";
            status.className = "timeline-form__status timeline-form__status--warning";
          }
          return;
        }

        if (!storage) {
          const status = document.getElementById("timelineAddImageStatus");
          if (status) {
            status.textContent = "Kh√¥ng th·ªÉ t·∫£i file v√¨ Firebase Storage ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.";
            status.className = "timeline-form__status timeline-form__status--error";
          }
          return;
        }

        const oversizedSelection = selectedMedia.find(
          (selection) => selection?.file?.size > MAX_UPLOAD_SIZE_BYTES
        );

        if (oversizedSelection) {
          const fileSizeMb = (
            oversizedSelection.file.size /
            (1024 * 1024)
          ).toFixed(1);
          const maxSizeMb = (MAX_UPLOAD_SIZE_BYTES / (1024 * 1024)).toFixed(0);
          const status = document.getElementById("timelineAddImageStatus");
          if (status) {
            status.textContent = `File ${oversizedSelection.file.name || ""} qu√° l·ªõn (${fileSizeMb}MB). Vui l√≤ng ch·ªçn file nh·ªè h∆°n ${maxSizeMb}MB.`;
            status.className = "timeline-form__status timeline-form__status--error";
          }
          return;
        }

        const status = document.getElementById("timelineAddImageStatus");
        const submitButton = document.getElementById("timelineAddImageSubmitButton");

        try {
          if (submitButton) {
            submitButton.disabled = true;
          }

          let newMediaItems = [];

          for (let index = 0; index < selectedMedia.length; index += 1) {
            const selection = selectedMedia[index];
            const captionValue = selection?.captionInput?.value?.trim() || "";

            if (status) {
              status.textContent = selectedMedia.length === 1
                ? "ƒêang t·∫£i file l√™n..."
                : `ƒêang t·∫£i file ${index + 1}/${selectedMedia.length}...`;
              status.className = "timeline-form__status timeline-form__status--pending";
            }

            const uploadedMedia = await uploadTimelineMediaFile(selection.file, {
              title: "",
              caption: captionValue,
            });

            newMediaItems.push({
              src: uploadedMedia.src,
              type: uploadedMedia.type,
              caption: captionValue || uploadedMedia.caption,
              alt: captionValue || uploadedMedia.alt,
              poster: uploadedMedia.poster || "",
              mimeType: uploadedMedia.mimeType || "",
            });
          }

          const entryRef = firestore.collection(TIMELINE_COLLECTION).doc(currentTimelineEntryId);
          const entryDoc = await entryRef.get();

          if (!entryDoc.exists) {
            throw new Error("Kh√¥ng t√¨m th·∫•y c·ªôt m·ªëc n√†y.");
          }

          const existingData = entryDoc.data();
          const existingImages = Array.isArray(existingData?.images) ? existingData.images : [];

          if (status) {
            status.textContent = "ƒêang c·∫≠p nh·∫≠t c·ªôt m·ªëc...";
            status.className = "timeline-form__status timeline-form__status--pending";
          }

          await entryRef.update({
            images: [...existingImages, ...newMediaItems],
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          if (status) {
            status.textContent = "ƒê√£ th√™m ·∫£nh th√†nh c√¥ng! üíï";
            status.className = "timeline-form__status timeline-form__status--success";
          }

          setTimeout(() => {
            closeTimelineAddImageModal();
          }, 1500);
        } catch (error) {
          console.error(error);
          if (status) {
            status.textContent = `Kh√¥ng th·ªÉ th√™m ·∫£nh: ${error?.message || String(error)}`;
            status.className = "timeline-form__status timeline-form__status--error";
          }
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
      }

      function attachAddImageHandlers() {
        const addImageButtons = document.querySelectorAll(".timeline-card__add-image-btn[data-timeline-id]");
        addImageButtons.forEach((button) => {
          if (button.dataset.addImageBound === "true") {
            return;
          }

          button.dataset.addImageBound = "true";
          button.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const timelineId = button.dataset.timelineId;
            if (timelineId) {
              openTimelineAddImageModal(timelineId);
            }
          });
        });
      }


      function setupLightboxInfrastructure() {
        lightboxElement = document.getElementById("lightbox");
        lightboxMediaContainer = document.getElementById("lightboxMedia");
        lightboxCaptionElement = document.getElementById("lightboxCaption");

        if (!lightboxElement) {
          return;
        }

        lightboxElement.addEventListener("click", (event) => {
          if (event.target && "lightboxClose" in event.target.dataset) {
            closeLightbox();
          }
        });

        const closeButtons = lightboxElement.querySelectorAll("[data-lightbox-close]");
        closeButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            event.preventDefault();
            closeLightbox();
          });
        });
      }

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          const heartMenuModal = document.getElementById("heartMenuModal");
          if (heartMenuModal && !heartMenuModal.hidden) {
            closeHeartMenuModal();
            return;
          }
          if (timelinePasswordModal && !timelinePasswordModal.hidden) {
            closeTimelinePasswordModal();
            return;
          }
          const addImageModal = document.getElementById("timelineAddImageModal");
          if (addImageModal && !addImageModal.hidden) {
            closeTimelineAddImageModal();
            return;
          }
          closeLightbox();
        }
      });

      function calculateDurations(now = new Date()) {
        if (!startDate) {
          return { years: 0, months: 0, weeks: 0, days: 0, totalDaysSinceStart: 0 };
        }

        const reference = new Date(now.getTime());
        reference.setHours(0, 0, 0, 0);

        let cursor = new Date(startDate.getTime());
        let years = 0;

        while (true) {
          const next = new Date(cursor);
          next.setFullYear(next.getFullYear() + 1);
          if (next <= reference) {
            years += 1;
            cursor = next;
          } else {
            break;
          }
        }

        let months = 0;
        while (true) {
          const next = new Date(cursor);
          next.setMonth(next.getMonth() + 1);
          if (next <= reference) {
            months += 1;
            cursor = next;
          } else {
            break;
          }
        }

        const remainingMs = reference - cursor;
        const totalDaysRemainder = Math.floor(remainingMs / MILLIS_PER_DAY);
        const weeks = Math.floor(totalDaysRemainder / 7);
        const days = totalDaysRemainder % 7;

        const totalDaysSinceStart =
          Math.floor(
            (Date.UTC(
              reference.getFullYear(),
              reference.getMonth(),
              reference.getDate()
            ) -
              Date.UTC(
                startDate.getFullYear(),
                startDate.getMonth(),
                startDate.getDate()
              )) /
              MILLIS_PER_DAY
          ) + 1;

        return { years, months, weeks, days, totalDaysSinceStart };
      }

      function updateDurations() {
        const { years, months, weeks, days, totalDaysSinceStart } = calculateDurations();

        document.getElementById("yearsValue").textContent = padTwo(years);
        document.getElementById("monthsValue").textContent = padTwo(months);
        document.getElementById("weeksValue").textContent = padTwo(weeks);
        document.getElementById("daysValue").textContent = padTwo(days);
        document.getElementById("dayCount").textContent = `ƒêang y√™u ${totalDaysSinceStart} ng√†y `;
      }

      function updateClock() {
        const now = new Date();
        const hours = padTwo(now.getHours());
        const minutes = padTwo(now.getMinutes());
        const seconds = padTwo(now.getSeconds());
        document.getElementById("liveClock").textContent = `${hours} : ${minutes} : ${seconds}`;
      }

      function displayError(message) {
        const grid = document.getElementById("timelineGrid");
        if (grid) {
          grid.innerHTML = `<p class="timeline-empty">${message}</p>`;
        }
      }

      async function initStory() {
        try {
          const data = await loadStoryConfig();
          applyConfig(data);
          updateDurations();
          updateClock();

          setInterval(() => {
            updateDurations();
            updateClock();
          }, 1000);
        } catch (error) {
          console.error(error);
          displayError("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu c√¢u chuy·ªán. Vui l√≤ng th·ª≠ l·∫°i sau.");
        }
      }

      const unlockHeart = document.getElementById("unlockHeart");
      const timelineToggle = document.getElementById("timelineToggle");
      const timelineSection = document.getElementById("timelineSection");
      const timelineSubmitSection = document.getElementById("timelineSubmitSection");
      const timelinePasswordModal = document.getElementById("timelinePasswordModal");
      const timelinePasswordForm = document.getElementById("timelinePasswordForm");
      const timelinePasswordInput = document.getElementById("timelinePasswordInput");
      const timelinePasswordToggle = document.getElementById("timelinePasswordToggle");
      const timelinePasswordStatus = document.getElementById("timelinePasswordStatus");
      const timelineDateInput = document.getElementById("timelineDateInput");
      const timelineDateDisplay = document.getElementById("timelineDateDisplay");
      const timelineDateIconBtn = document.getElementById("timelineDateIconBtn");
      const timelineMediaFileInput = document.getElementById("timelineMediaFile");
      const timelineAddMoreMediaBtn = document.getElementById("timelineAddMoreMediaBtn");
      const timelineMediaPreviewContainer = document.getElementById("timelineMediaPreviewContainer");
      const timelineMediaPreviewList = document.getElementById("timelineMediaPreviewList");
      const timelineForm = document.getElementById("timelineForm");
      const timelineSubmitButton = document.getElementById("timelineSubmitButton");
      const timelineFormStatus = document.getElementById("timelineFormStatus");

      if (timelineToggle && timelineSection) {
        timelineToggle.addEventListener("click", () => {
          const isOpen = timelineSection.classList.toggle("open");
          timelineSection.setAttribute("aria-hidden", (!isOpen).toString());
          timelineToggle.textContent = isOpen
            ? "·∫®n c·ªôt m·ªëc y√™u th∆∞∆°ng"
            : "Xem c·ªôt m·ªëc y√™u th∆∞∆°ng";
        });
      }

      if (unlockHeart) {
        unlockHeart.addEventListener("click", handleHeartActivation);
        unlockHeart.addEventListener("keydown", handleHeartActivation);
      }

      const heartMenuModal = document.getElementById("heartMenuModal");
      const heartMenuTodoButton = document.getElementById("heartMenuTodoButton");
      const heartMenuTimelineButton = document.getElementById("heartMenuTimelineButton");

      if (heartMenuModal) {
        heartMenuModal.addEventListener("click", (event) => {
          const target = event.target;
          if (target && "heartMenuClose" in target.dataset) {
            closeHeartMenuModal();
          }
        });
      }

      if (heartMenuTodoButton) {
        heartMenuTodoButton.addEventListener("click", () => {
          navigateToPage("todo");
        });
      }

      if (heartMenuTimelineButton) {
        heartMenuTimelineButton.addEventListener("click", () => {
          navigateToPage("timeline");
        });
      }

      if (timelinePasswordModal) {
        timelinePasswordModal.addEventListener("click", (event) => {
          const target = event.target;
          if (target && "passwordModalClose" in target.dataset) {
            closeTimelinePasswordModal();
          }
        });
      }

      function togglePasswordVisibility() {
        if (!timelinePasswordInput || !timelinePasswordToggle) return;

        const isPassword = timelinePasswordInput.type === "password";
        timelinePasswordInput.type = isPassword ? "text" : "password";

        const hiddenIcon = timelinePasswordToggle.querySelector(
          ".timeline-form__password-icon--hidden"
        );
        const visibleIcon = timelinePasswordToggle.querySelector(
          ".timeline-form__password-icon--visible"
        );

        if (hiddenIcon && visibleIcon) {
          if (isPassword) {
            hiddenIcon.style.display = "none";
            visibleIcon.style.display = "block";
            timelinePasswordToggle.setAttribute("aria-pressed", "true");
            timelinePasswordToggle.setAttribute("aria-label", "·∫®n m·∫≠t kh·∫©u");
          } else {
            hiddenIcon.style.display = "block";
            visibleIcon.style.display = "none";
            timelinePasswordToggle.setAttribute("aria-pressed", "false");
            timelinePasswordToggle.setAttribute("aria-label", "Hi·ªán m·∫≠t kh·∫©u");
          }
        }
      }

      if (timelinePasswordToggle && timelinePasswordInput) {
        timelinePasswordToggle.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          togglePasswordVisibility();
        });
      }

      if (timelinePasswordForm) {
        timelinePasswordForm.addEventListener("submit", handleTimelinePasswordSubmit);
      }

      if (timelineMediaFileInput) {
        timelineMediaFileInput.addEventListener("change", handleTimelineMediaSelection);
      }

      if (timelineAddMoreMediaBtn) {
        timelineAddMoreMediaBtn.addEventListener("click", handleAddMoreMediaClick);
      }

      function openDatePicker() {
        if (timelineDateInput) {
          timelineDateInput.showPicker?.();
          timelineDateInput.focus();
          timelineDateInput.click();
        }
      }

      if (timelineDateInput) {
        timelineDateInput.addEventListener("change", updateDateDisplay);
        timelineDateInput.addEventListener("input", updateDateDisplay);
      }

      if (timelineDateDisplay) {
        timelineDateDisplay.addEventListener("click", openDatePicker);
        // Remove auto-open on focus, only open on explicit click
      }

      if (timelineDateIconBtn && timelineDateInput) {
        timelineDateIconBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openDatePicker();
        });
      }

      if (timelineForm) {
        timelineForm.addEventListener("submit", handleTimelineSubmit);
      }

      const timelineAddImageModal = document.getElementById("timelineAddImageModal");
      const timelineAddImageForm = document.getElementById("timelineAddImageForm");
      const timelineAddImageFile = document.getElementById("timelineAddImageFile");
      const timelineAddImageMoreBtn = document.getElementById("timelineAddImageMoreBtn");

      if (timelineAddImageModal) {
        timelineAddImageModal.addEventListener("click", (event) => {
          const target = event.target;
          if (target && "addImageModalClose" in target.dataset) {
            closeTimelineAddImageModal();
          }
        });
      }

      if (timelineAddImageFile) {
        timelineAddImageFile.addEventListener("change", handleTimelineAddImageSelection);
      }

      if (timelineAddImageMoreBtn) {
        timelineAddImageMoreBtn.addEventListener("click", handleAddMoreImageClick);
      }

      if (timelineAddImageForm) {
        timelineAddImageForm.addEventListener("submit", handleTimelineAddImageSubmit);
      }

      setupLightboxInfrastructure();
      setupTimeSlider();
      initStory();
      initFirebaseTimeline();

      // Sync date display on page load if date input has value
      if (timelineDateInput && timelineDateDisplay && timelineDateInput.value) {
        updateDateDisplay();
      }

      window.addEventListener("unload", () => {
        if (typeof timelineUnsubscribe === "function") {
          timelineUnsubscribe();
        }
      });
    </script>
  </body>
</html>

