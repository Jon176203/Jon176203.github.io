<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh s√°ch vi·ªác c·∫ßn l√†m - T·ª•i m√¨nh</title>
    <meta
      name="description"
      content="Danh s√°ch vi·ªác c·∫ßn l√†m c√πng nhau c·ªßa Qu√¢n v√† Qu·ª≥nh"
    />
    <link rel="icon" type="image/svg+xml" href="assets/heart-favicon.svg" />
    <link rel="alternate icon" href="assets/heart-favicon.svg" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="floating-hearts" aria-hidden="true">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
    <main class="love-card">
      <button class="page-back-button" id="pageBackButton" type="button" onclick="window.location.href='index.html'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        <span>Quay l·∫°i</span>
      </button>
      <div class="title" id="storyTitle">Danh s√°ch vi·ªác c·∫ßn l√†m</div>
      <p class="story-subtitle">C√πng nhau ho√†n th√†nh nh·ªØng vi·ªác nh·ªè xinh nh√©! üíï</p>
      
      <section class="todo-list-page" id="todoListPage">
        <div class="todo-list" id="todoList"></div>
      </section>
      
      <section class="todo-submit" id="todoSubmitSection">
        <h2 class="todo-submit__title">Th√™m vi·ªác c·∫ßn l√†m c√πng nhau</h2>
        <p class="todo-submit__hint">
          C√πng nhau ho√†n th√†nh nh·ªØng vi·ªác nh·ªè xinh nh√©! üíï
        </p>
        <form class="todo-form" id="todoForm" novalidate>
          <label class="todo-form__field">
            <span>N·ªôi dung vi·ªác c·∫ßn l√†m *</span>
            <input
              type="text"
              name="todoText"
              id="todoTextInput"
              maxlength="200"
              required
              placeholder="V√≠ d·ª•: ƒêi xem phim c√πng nhau"
            />
          </label>
          <button class="todo-form__submit" id="todoSubmitButton" type="submit">
            ·∫§n ƒë√¢y ƒë·ªÉ th√™m nha bae :3
          </button>
          <p class="todo-form__status" id="todoFormStatus" role="status" aria-live="polite"></p>
        </form>
      </section>
    </main>

    <!-- Modal x√°c nh·∫≠n m·∫≠t kh·∫©u khi x√≥a -->
    <div class="todo-delete-password-modal" id="todoDeletePasswordModal" hidden>
      <div class="todo-delete-password-modal__backdrop" data-delete-password-modal-close></div>
      <div class="todo-delete-password-modal__dialog">
        <button
          type="button"
          class="todo-delete-password-modal__close"
          data-delete-password-modal-close
          aria-label="ƒê√≥ng"
        >
          √ó
        </button>
        <h2 class="todo-delete-password-modal__title">X√°c nh·∫≠n x√≥a</h2>
        <p class="todo-delete-password-modal__hint">
          Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ x√°c nh·∫≠n x√≥a vi·ªác c·∫ßn l√†m n√†y
        </p>
        <form class="todo-delete-password-modal__form" id="todoDeletePasswordForm" novalidate>
          <label class="todo-delete-password-modal__field">
            <span>M·∫≠t kh·∫©u *</span>
            <input
              type="password"
              id="deletePasswordInput"
              required
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
              autocomplete="off"
            />
          </label>
          <p class="todo-delete-password-modal__status" id="deletePasswordStatus" role="status" aria-live="polite"></p>
          <div class="todo-delete-password-modal__buttons">
            <button
              type="button"
              class="todo-delete-password-modal__cancel"
              data-delete-password-modal-close
            >
              H·ªßy
            </button>
            <button
              type="submit"
              class="todo-delete-password-modal__submit"
              id="deletePasswordSubmitButton"
            >
              X√°c nh·∫≠n x√≥a
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal ch·ªçn ng√†y gi·ªù ho√†n th√†nh -->
    <div class="todo-completion-modal" id="todoCompletionModal" hidden>
      <div class="todo-completion-modal__backdrop" data-completion-modal-close></div>
      <div class="todo-completion-modal__dialog">
        <button
          type="button"
          class="todo-completion-modal__close"
          data-completion-modal-close
          aria-label="ƒê√≥ng"
        >
          √ó
        </button>
        <h2 class="todo-completion-modal__title">Ch·ªçn ng√†y v√† gi·ªù ho√†n th√†nh</h2>
        <form class="todo-completion-modal__form" id="todoCompletionForm" novalidate>
          <label class="todo-completion-modal__field">
            <span>Ng√†y ho√†n th√†nh *</span>
            <input
              type="date"
              id="completionDateInput"
              required
            />
          </label>
          <label class="todo-completion-modal__field">
            <span>Gi·ªù ho√†n th√†nh *</span>
            <input
              type="time"
              id="completionTimeInput"
              required
            />
          </label>
          <div class="todo-completion-modal__buttons">
            <button
              type="button"
              class="todo-completion-modal__cancel"
              data-completion-modal-close
            >
              H·ªßy
            </button>
            <button
              type="submit"
              class="todo-completion-modal__submit"
              id="completionSubmitButton"
            >
              X√°c nh·∫≠n
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
      const TODO_COLLECTION = "todos";
      const TIMELINE_FORM_PASSWORD = "tuilavoquan";

      let firestore = null;
      let todoUnsubscribe = null;
      let timelineFormUnlocked = false;
      let isFirebaseReady = false;
      let currentTodoIdForCompletion = null;
      let currentTodoIdForDelete = null;

      function escapeHtml(value = "") {
        return value
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function escapeAttribute(value = "") {
        return escapeHtml(value);
      }

      function autoResizeTextarea(textarea) {
        if (!textarea) return;
        textarea.style.height = "auto";
        const scrollHeight = textarea.scrollHeight;
        const minHeight = 42;
        const maxHeight = 200;
        textarea.style.height = `${Math.min(Math.max(scrollHeight, minHeight), maxHeight)}px`;
        textarea.style.overflowY = scrollHeight > maxHeight ? "auto" : "hidden";
      }

      function formatDateTime(dateTime) {
        if (!dateTime) return "";
        const date = dateTime.toDate ? dateTime.toDate() : new Date(dateTime);
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        return `${day}/${month}/${year} ${hours}:${minutes}`;
      }

      function createTodoItem(todo = {}) {
        const { id, text = "", completed = false, createdAt, completedAt } = todo;
        const safeId = id ? escapeAttribute(id) : "";
        const safeText = escapeHtml(text);
        const isCompleted = Boolean(completed);
        const canEdit = timelineFormUnlocked;
        const completedAtText = completedAt ? formatDateTime(completedAt) : "";

        return `
          <div class="todo-item ${isCompleted ? "todo-item--completed" : ""}" data-todo-id="${safeId}">
            <label class="todo-item__checkbox-wrapper">
              <input
                type="checkbox"
                class="todo-item__checkbox"
                ${isCompleted ? "checked" : ""}
                ${canEdit ? "" : "disabled"}
                data-todo-checkbox="${safeId}"
              />
              <span class="todo-item__checkmark"></span>
            </label>
            <div class="todo-item__content">
              <span class="todo-item__text">${safeText}</span>
              ${completedAtText ? `<span class="todo-item__completed-date">Ho√†n th√†nh: ${escapeHtml(completedAtText)}</span>` : ""}
            </div>
            ${canEdit ? `<button type="button" class="todo-item__delete" data-todo-delete="${safeId}" aria-label="X√≥a">√ó</button>` : ""}
          </div>
        `;
      }

      function renderTodoList(todos = []) {
        const todoListContainer = document.getElementById("todoList");
        if (!todoListContainer) return;

        if (!Array.isArray(todos) || todos.length === 0) {
          todoListContainer.innerHTML =
            '<p class="todo-empty">Ch∆∞a c√≥ vi·ªác c·∫ßn l√†m n√†o ‚Äî c√πng nhau t·∫°o danh s√°ch nh√©! üíï</p>';
          return;
        }

        const sortedTodos = todos.slice().sort((a, b) => {
          // Ch∆∞a ho√†n th√†nh tr∆∞·ªõc, ƒë√£ ho√†n th√†nh sau
          if (a.completed !== b.completed) {
            return a.completed ? 1 : -1;
          }
          // S·∫Øp x·∫øp theo th·ªùi gian t·∫°o (m·ªõi nh·∫•t tr∆∞·ªõc)
          const timeA = a.createdAt?.toMillis?.() || a.createdAt || 0;
          const timeB = b.createdAt?.toMillis?.() || b.createdAt || 0;
          return timeB - timeA;
        });

        todoListContainer.innerHTML = sortedTodos.map(createTodoItem).join("");
        attachTodoHandlers();
      }

      function renderTodoLoading() {
        const todoListContainer = document.getElementById("todoList");
        if (!todoListContainer) return;
        todoListContainer.innerHTML = `
          <div class="todo-loading">
            <div class="todo-loading__spinner"></div>
            <div class="todo-loading__text">ƒêang t·∫£i danh s√°ch vi·ªác c·∫ßn l√†m c√πng nhau...</div>
          </div>
        `;
      }

      function attachTodoHandlers() {
        const checkboxes = document.querySelectorAll("[data-todo-checkbox]");
        checkboxes.forEach((checkbox) => {
          if (checkbox.dataset.todoHandlerBound === "true") {
            return;
          }

          checkbox.dataset.todoHandlerBound = "true";
          checkbox.addEventListener("change", async (e) => {
            const todoId = checkbox.dataset.todoCheckbox;
            if (!todoId || !firestore || !timelineFormUnlocked) {
              checkbox.checked = false;
              return;
            }

            const isChecked = checkbox.checked;

            // N·∫øu ƒëang uncheck (ƒë√£ completed), cho ph√©p uncheck
            if (!isChecked) {
              try {
                await firestore.collection(TODO_COLLECTION).doc(todoId).update({
                  completed: false,
                  completedAt: null,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
              } catch (error) {
                console.error(error);
                checkbox.checked = true; // Revert checkbox
                alert(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t: ${error?.message || String(error)}`);
              }
              return;
            }

            // N·∫øu ƒëang check (ch∆∞a completed), m·ªü modal ƒë·ªÉ ch·ªçn ng√†y gi·ªù
            e.preventDefault();
            checkbox.checked = false; // T·∫°m th·ªùi kh√¥ng check
            openCompletionModal(todoId);
          });
        });

        const deleteButtons = document.querySelectorAll("[data-todo-delete]");
        deleteButtons.forEach((button) => {
          if (button.dataset.todoDeleteBound === "true") {
            return;
          }

          button.dataset.todoDeleteBound = "true";
          button.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const todoId = button.dataset.todoDelete;
            if (!todoId || !firestore || !timelineFormUnlocked) {
              return;
            }

            // M·ªü modal x√°c nh·∫≠n m·∫≠t kh·∫©u
            openDeletePasswordModal(todoId);
          });
        });
      }

      function subscribeToTodoCollection() {
        if (!firestore) {
          return;
        }

        if (typeof todoUnsubscribe === "function") {
          todoUnsubscribe();
        }

        // Hi·ªÉn th·ªã loading tr∆∞·ªõc khi c√≥ snapshot ƒë·∫ßu ti√™n
        renderTodoLoading();

        const collectionRef = firestore
          .collection(TODO_COLLECTION)
          .orderBy("createdAt", "desc");

        todoUnsubscribe = collectionRef.onSnapshot(
          (snapshot) => {
            const todos = snapshot.docs.map((doc) => {
              const data = doc.data();
              return {
                id: doc.id,
                text: data.text || "",
                completed: Boolean(data.completed),
                completedAt: data.completedAt,
                createdAt: data.createdAt,
                updatedAt: data.updatedAt,
              };
            });

            renderTodoList(todos);
          },
          (error) => {
            console.error(error);
            renderTodoList([]);
          }
        );
      }

      function setTodoFormEnabled(isEnabled) {
        const todoForm = document.getElementById("todoForm");
        if (!todoForm) {
          return;
        }

        const enableForm = Boolean(isEnabled && timelineFormUnlocked);
        const elements = todoForm.querySelectorAll("input, button");
        elements.forEach((element) => {
          element.disabled = !enableForm;
        });

        todoForm.classList.toggle("todo-form--disabled", !enableForm);
      }

      function setTodoFormStatus(message, type = "info") {
        const status = document.getElementById("todoFormStatus");
        if (!status) {
          return;
        }

        status.textContent = message || "";
        const statusTypes = ["info", "success", "warning", "error", "pending"];
        statusTypes.forEach((statusType) => {
          status.classList.toggle(`todo-form__status--${statusType}`, statusType === type);
        });
      }

      async function handleTodoSubmit(event) {
        event.preventDefault();

        if (!timelineFormUnlocked) {
          setTodoFormStatus("B·∫°n c·∫ßn m·ªü kh√≥a b·∫±ng m·∫≠t kh·∫©u tr∆∞·ªõc khi th√™m vi·ªác c·∫ßn l√†m nha üíñ", "warning");
          return;
        }

        if (!firestore) {
          setTodoFormStatus("Ch·ª©c nƒÉng th√™m vi·ªác c·∫ßn l√†m ƒëang ƒë∆∞·ª£c thi·∫øt l·∫≠p. Vui l√≤ng quay l·∫°i sau nh√©!", "warning");
          return;
        }

        const todoForm = document.getElementById("todoForm");
        const todoTextInput = document.getElementById("todoTextInput");
        if (!todoForm || !todoTextInput) {
          return;
        }

        const todoText = (todoTextInput.value || "").trim();
        if (!todoText) {
          setTodoFormStatus("Vui l√≤ng nh·∫≠p n·ªôi dung vi·ªác c·∫ßn l√†m.", "warning");
          return;
        }

        const submitButton = document.getElementById("todoSubmitButton");
        try {
          if (submitButton) {
            submitButton.disabled = true;
          }

          setTodoFormStatus("ƒêang th√™m vi·ªác c·∫ßn l√†m...", "pending");

          await firestore.collection(TODO_COLLECTION).add({
            text: todoText,
            completed: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          todoForm.reset();
          setTodoFormStatus("ƒê√£ th√™m vi·ªác c·∫ßn l√†m th√†nh c√¥ng! üíï", "success");

          setTimeout(() => {
            setTodoFormStatus("");
          }, 2000);
        } catch (error) {
          console.error(error);
          setTodoFormStatus(`Kh√¥ng th·ªÉ th√™m vi·ªác c·∫ßn l√†m: ${error?.message || String(error)}`, "error");
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
      }

      function openCompletionModal(todoId) {
        const modal = document.getElementById("todoCompletionModal");
        const dateInput = document.getElementById("completionDateInput");
        const timeInput = document.getElementById("completionTimeInput");
        
        if (!modal || !dateInput || !timeInput) {
          return;
        }

        currentTodoIdForCompletion = todoId;

        // Set default values to current date and time
        const now = new Date();
        const dateStr = now.toISOString().split("T")[0];
        const timeStr = `${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;

        dateInput.value = dateStr;
        timeInput.value = timeStr;

        modal.hidden = false;
        document.body.classList.add("todo-completion-modal-open");
        dateInput.focus();
      }

      function closeCompletionModal() {
        const modal = document.getElementById("todoCompletionModal");
        if (!modal) {
          return;
        }

        modal.hidden = true;
        document.body.classList.remove("todo-completion-modal-open");
        currentTodoIdForCompletion = null;
      }

      async function handleCompletionSubmit(event) {
        event.preventDefault();

        if (!currentTodoIdForCompletion || !firestore) {
          return;
        }

        const dateInput = document.getElementById("completionDateInput");
        const timeInput = document.getElementById("completionTimeInput");
        const submitButton = document.getElementById("completionSubmitButton");

        if (!dateInput || !timeInput) {
          return;
        }

        const dateValue = dateInput.value;
        const timeValue = timeInput.value;

        if (!dateValue || !timeValue) {
          alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y v√† gi·ªù ho√†n th√†nh.");
          return;
        }

        try {
          if (submitButton) {
            submitButton.disabled = true;
          }

          // Combine date and time
          const [year, month, day] = dateValue.split("-");
          const [hours, minutes] = timeValue.split(":");
          const completedDate = new Date(year, month - 1, day, hours, minutes);

          await firestore.collection(TODO_COLLECTION).doc(currentTodoIdForCompletion).update({
            completed: true,
            completedAt: firebase.firestore.Timestamp.fromDate(completedDate),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          closeCompletionModal();
        } catch (error) {
          console.error(error);
          alert(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t: ${error?.message || String(error)}`);
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
      }

      function openDeletePasswordModal(todoId) {
        const modal = document.getElementById("todoDeletePasswordModal");
        const passwordInput = document.getElementById("deletePasswordInput");
        
        if (!modal || !passwordInput) {
          return;
        }

        currentTodoIdForDelete = todoId;

        // Reset form
        const form = document.getElementById("todoDeletePasswordForm");
        if (form) {
          form.reset();
        }
        setDeletePasswordStatus("", "info");

        modal.hidden = false;
        document.body.classList.add("todo-delete-password-modal-open");
        passwordInput.focus();
      }

      function closeDeletePasswordModal() {
        const modal = document.getElementById("todoDeletePasswordModal");
        if (!modal) {
          return;
        }

        modal.hidden = true;
        document.body.classList.remove("todo-delete-password-modal-open");
        currentTodoIdForDelete = null;

        // Reset form
        const form = document.getElementById("todoDeletePasswordForm");
        const passwordInput = document.getElementById("deletePasswordInput");
        if (form) {
          form.reset();
        }
        if (passwordInput) {
          passwordInput.value = "";
        }
        setDeletePasswordStatus("", "info");
      }

      function setDeletePasswordStatus(message, type = "info") {
        const status = document.getElementById("deletePasswordStatus");
        if (!status) {
          return;
        }

        status.textContent = message || "";
        const statusTypes = ["info", "success", "warning", "error", "pending"];
        statusTypes.forEach((statusType) => {
          status.classList.toggle(`todo-delete-password-modal__status--${statusType}`, statusType === type);
        });
      }

      async function handleDeletePasswordSubmit(event) {
        event.preventDefault();

        if (!currentTodoIdForDelete || !firestore) {
          return;
        }

        const passwordInput = document.getElementById("deletePasswordInput");
        const submitButton = document.getElementById("deletePasswordSubmitButton");

        if (!passwordInput) {
          return;
        }

        const submittedPassword = passwordInput.value.trim();

        if (submittedPassword !== TIMELINE_FORM_PASSWORD) {
          setDeletePasswordStatus("Sai m·∫≠t kh·∫©u r·ªìi, th·ª≠ l·∫°i nh√© üíî", "error");
          passwordInput.value = "";
          passwordInput.focus();
          return;
        }

        try {
          if (submitButton) {
            submitButton.disabled = true;
          }

          setDeletePasswordStatus("ƒêang x√≥a...", "pending");

          await firestore.collection(TODO_COLLECTION).doc(currentTodoIdForDelete).delete();

          closeDeletePasswordModal();
        } catch (error) {
          console.error(error);
          setDeletePasswordStatus(`Kh√¥ng th·ªÉ x√≥a: ${error?.message || String(error)}`, "error");
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
      }

      function checkUnlockStatus() {
        // Ki·ªÉm tra localStorage ƒë·ªÉ xem ƒë√£ unlock ch∆∞a
        const unlocked = localStorage.getItem("timelineFormUnlocked");
        if (unlocked === "true") {
          timelineFormUnlocked = true;
          setTodoFormEnabled(true);
          setTodoFormStatus("", "info");
        } else {
          timelineFormUnlocked = false;
          setTodoFormEnabled(false);
          setTodoFormStatus("Vui l√≤ng quay l·∫°i trang ch√≠nh v√† nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y.", "warning");
        }
      }

      function initFirebase() {
        if (!window.firebase || !window.FIREBASE_CONFIG) {
          setTodoFormStatus("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.", "error");
          return;
        }

        try {
          if (!firebase.apps.length) {
            firebase.initializeApp(window.FIREBASE_CONFIG);
          }
          firestore = firebase.firestore();
          isFirebaseReady = true;
          
          checkUnlockStatus();
          // Hi·ªÉn th·ªã loading ngay khi kh·ªüi t·∫°o
          renderTodoLoading();
          subscribeToTodoCollection();
        } catch (error) {
          console.error(error);
          setTodoFormStatus("Kh√¥ng th·ªÉ kh·ªüi t·∫°o Firebase.", "error");
        }
      }

      const todoForm = document.getElementById("todoForm");
      if (todoForm) {
        todoForm.addEventListener("submit", handleTodoSubmit);
      }

      const completionModal = document.getElementById("todoCompletionModal");
      const completionForm = document.getElementById("todoCompletionForm");
      
      if (completionModal) {
        completionModal.addEventListener("click", (event) => {
          const target = event.target;
          if (target && "completionModalClose" in target.dataset) {
            closeCompletionModal();
          }
        });
      }

      if (completionForm) {
        completionForm.addEventListener("submit", handleCompletionSubmit);
      }

      const deletePasswordModal = document.getElementById("todoDeletePasswordModal");
      const deletePasswordForm = document.getElementById("todoDeletePasswordForm");
      
      if (deletePasswordModal) {
        deletePasswordModal.addEventListener("click", (event) => {
          const target = event.target;
          if (target && "deletePasswordModalClose" in target.dataset) {
            closeDeletePasswordModal();
          }
        });
      }

      if (deletePasswordForm) {
        deletePasswordForm.addEventListener("submit", handleDeletePasswordSubmit);
      }

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          const deleteModal = document.getElementById("todoDeletePasswordModal");
          if (deleteModal && !deleteModal.hidden) {
            closeDeletePasswordModal();
            return;
          }
          const completionModal = document.getElementById("todoCompletionModal");
          if (completionModal && !completionModal.hidden) {
            closeCompletionModal();
          }
        }
      });

      initFirebase();

      window.addEventListener("unload", () => {
        if (typeof todoUnsubscribe === "function") {
          todoUnsubscribe();
        }
      });
    </script>
  </body>
</html>

